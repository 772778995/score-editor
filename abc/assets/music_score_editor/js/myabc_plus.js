/* myabc_plus */

function showStaffProp() {
  setSpeedSelected();
  initStaffProp();
  $("#STAFF_div .modal-content")["css"](
    "left",
    ($(window)["width"]() - $("#STAFF_div .modal-content")["width"]()) / 2
  );
  $("#STAFF_div .modal-content")["css"]("width", "950px");
  $("#STAFF_div")["modal"]();
}
function initStaffProp() {
  var _0x15705 =
    '<select staffnum="NUM" id="staffclefNUM" class="staffcleftype">' +
    '<option value="treble">\u9ad8\u97f3\u8c31\u53f7</option>' +
    '<option value="bass">\u4f4e\u97f3\u8c31\u53f7</option>' +
    '<option value="alto">\u4e2d\u97f3\u8c31\u53f7</option>' +
    '<option value="tenor">\u6b21\u4e2d\u97f3\u8c31\u53f7</option>' +
    "</select>";
  var _0x1582B = '<select id="toneNUM" class="toneClass" style="width:150px;">';
  for (
    var _0x11901 = 0;
    _0x11901 < content_vue["instrumentList"]["length"];
    _0x11901++
  ) {
    _0x1582B +=
      '<option value="' +
      content_vue["instrumentList"][_0x11901]["code"] +
      '">' +
      content_vue["instrumentList"][_0x11901]["name"] +
      "</option>";
  }
  _0x1582B += "</select>";
  var _0x157C9 =
    '<div id="staffPropNUM" staffnum="NUM" class="staffProp" style="padding-top:5px;"> \u8c31\u53f7\uff1a' +
    _0x15705 +
    ' \u8c31\u8868\u540d\u79f0\uff1a<input staffnum="NUM" id="nmNUM" type="text" style="width:85px;">&nbsp;' +
    '\u526f\u540d\u79f0\uff1a<input staffnum="NUM" id="snmNUM" type="text" style="width:85px;">' +
    "\u97f3\u8272\uff1a" +
    _0x1582B +
    '\u8282\u594f\u8c31\uff1a<input type="checkbox" staffnum="NUM" onclick="switchRhythm(this)" id="isRhythm" class="isRhythm" style="width:20px;margin-left: 0px;margin-right: 0px;">' +
    "</div>";
  var staff_num = parseInt($("#STAFFNUM")["val"]());
  var _0x15767 = $(".staffcleftype")["length"];
  if (staff_num > _0x15767) {
    for (var _0x11901 = 1; _0x11901 <= parseInt(staff_num); _0x11901++) {
      var _0x12541 = _0x157C9["replaceAll"]("NUM", _0x11901) + "";
      if ($("#staffProp" + _0x11901)["length"] == 0) {
        $("#staffsettingdiv")["append"]($(_0x12541));
      }
    }
  } else {
    if (staff_num < _0x15767) {
      for (var _0x11901 = staff_num + 1; _0x11901 <= _0x15767; _0x11901++) {
        $("#staffProp" + _0x11901)["remove"]();
      }
    }
  }
}
function initStaffSplit() {
  var _0x158EF = '<input class="staffoption" seq="SEQ" style="width:30px;text-align:center;">';
  var _0x15951 = '<input class="staffoption" seq="SEQ" style="width:30px;text-align:center;">';
  var _0x159B3 = '<span seq="SEQ">SEQ</span>';
  var staff_num = parseInt($("#STAFFNUM")["val"]());
  var _0x1588D = $("input[seq]")["length"];
  if (staff_num > _0x1588D - 1) {
    $("input[seq='" + _0x1588D + "']")["remove"]();
    for (var _0x11901 = _0x1588D; _0x11901 <= parseInt(staff_num); _0x11901++) {
      if (_0x11901 == 0) {
        continue;
      }
      if ($("input[seq='" + _0x11901 + "']")["length"] == 0) {
        var _0x15A15 = _0x158EF["replaceAll"]("SEQ", _0x11901);
        var _0x15A77 = _0x159B3["replaceAll"]("SEQ", _0x11901);
        $("#staffSplitDiv")["append"]($(_0x15A15))["append"]($(_0x15A77));
      }
    }
    var _0x15A15 = _0x15951["replaceAll"]("SEQ", staff_num + 1);
    var _0x15A77 = _0x159B3["replaceAll"]("SEQ", staff_num + 1);
    $("#staffSplitDiv")["append"]($(_0x15A15));
  } else {
    if (staff_num < _0x1588D - 1) {
      for (var _0x11901 = staff_num + 1; _0x11901 <= _0x1588D; _0x11901++) {
        $("input[seq='" + _0x11901 + "']")["remove"]();
        $("span[seq='" + _0x11901 + "']")["remove"]();
      }
      var _0x15A15 = _0x15951["replaceAll"]("SEQ", staff_num + 1);
      var _0x15A77 = _0x159B3["replaceAll"]("SEQ", staff_num + 1);
      $("#staffSplitDiv")["append"]($(_0x15A15));
    }
  }
}
function popStaffProp() {
  updateStaffPropStatus = true;
  if ($("#staffProp1")["length"] == 0) {
    initStaffProp();
    $("#STAFF_div .modal-content")["css"](
      "left",
      ($(window)["width"]() - $("#DO_CHN_div .modal-content")["width"]()) / 2
    );
    $("#STAFF_div .modal-content")["css"]("width", "950px");
    $("#STAFF_div")["modal"]();
    return;
  }
  $("#STAFF_div")["modal"]();
}
function genWeakBarRestNotes(WeakBarInfo) {
  var _0x14AC5 = new Object();
  _0x14AC5["top"] = parseInt($("#M_mol")["val"]());
  _0x14AC5["bot"] = parseInt($("#M_den")["val"]());
  var _0x14B89 = new Object();
  _0x14B89["top"] = parseInt(
    $("#L")["val"]()["split"]("/")[0]
  );
  _0x14B89["bot"] = parseInt(
    $("#L")["val"]()["split"]("/")[1]
  );
  var _0x1437F = _0x14B89["bot"] / WeakBarInfo["bot"];
  if (_0x1437F != parseInt(_0x1437F)) {
    return "";
  }
  return genznotes(_0x1437F * WeakBarInfo["top"]);
}
function genznotes(staff_num) {
  var _0x1241B = parseInt(staff_num / 2);
  var _0x13245 = staff_num % 2;
  var _0x11C11 = "";
  for (var _0x11901 = 0; _0x11901 < _0x1241B; _0x11901++) {
    _0x11C11 += "z2";
  }
  if (_0x13245 != 0 && _0x13245 % 1 == 0) {
    _0x11C11 += "z";
  } else {
    if (_0x13245 != 0 && _0x13245 % 1 != 0) {
      var _0x14F5D = "";
      if (_0x13245 > 1) {
        _0x14F5D += "z";
      }
      var _0x14EFB = _0x13245 % 1;
      for (_0x11901 = 2; ; _0x11901 *= 2) {
        _0x14F5D += "/";
        if (1 / _0x11901 == _0x14EFB) {
          break;
        }
      }
      _0x11C11 += "z" + _0x14F5D;
    }
  }
  return _0x11C11;
}
function genInitStaff() {
  lastMidiReplaceNoteIstart = -1;
  lastMidiReplaceNoteV = -1;
  if (updateStaffPropStatus) {
    updateStaffPropStatus = false;
    updateStaffProp();
    return;
  }
  var abc_content = $("#source")["val"]();
  var gen_v_setting = genVSetting();
  var staff_num = parseInt($("#STAFFNUM")["val"]());
  var node_count = parseInt($("#nodecount")["val"]());
  var barsperstaff = $("#barsperstaff")["val"]();
  var weak_bar_rest_notes = "";
  var WeakBarInfo = null;
  if ($("#isR")["is"](":checked")) {
    WeakBarInfo = new Object();
    WeakBarInfo["top"] = parseInt($("#weakBarTop")["val"]());
    WeakBarInfo["bot"] = parseInt($("#weakBarBot")["val"]());
  }
  if (WeakBarInfo != null) {
    weak_bar_rest_notes = genWeakBarRestNotes(WeakBarInfo);
    if (weak_bar_rest_notes != "") {
      weak_bar_rest_notes += "|";
    }
  }
  // console.log('genInitStaff abc_content ', abc_content);
  var n_score_str = "";
  var score_str = getScoreStr();
  if (score_str && score_str != "") {
    var check_score = /%%(score|staves).*/;
    var c_score_res = abc_content["match"](check_score);
    if (c_score_res != null) {
      abc_content = abc_content["replace"](c_score_res[0], score_str);
    } else {
      n_score_str += score_str + "\x0A";
    }
  }
  n_score_str += gen_v_setting;
  for (var i = 1; i <= staff_num; i++) {
    n_score_str += "V:" + i + "\x0A";
    var r_str = weak_bar_rest_notes + genNodesByCount(node_count);
    if (i == 1 && parseInt(barsperstaff) != -1) {
    }
    n_score_str += r_str + "%V" + i + "line0end\x0A";
  }
  var abc_content_arr = abc_content["split"]("\x0A"); // "\x0A" == "\\n"
  // console.log('genInitStaff abc_content_arr ', abc_content_arr);

  var new_abc_content = "";
  for (var i = 0; i < abc_content_arr["length"]; i++) {
    // if (abc_content_arr[i] == "%%vsetting_start") {
    //   break;
    // }
    // 修改后:
    if(abc_content_arr[i].indexOf('%%score')>-1 || abc_content_arr[i] == "%%vsetting_start"){
      break;
    }
    new_abc_content += abc_content_arr[i] + "\x0A";
  }
  // console.log('genInitStaff new_abc_content', new_abc_content);
  // console.log('genInitStaff n_score_str', n_score_str);

  new_abc_content += n_score_str;
  new_abc_content = handleBreakLine(new_abc_content, parseInt(barsperstaff));

  // console.log('genInitStaff new_abc_content', new_abc_content);
  var M_type = $("#M_type")["val"]();
  if (M_type != "1") {
    new_abc_content = new_abc_content["replace"](/M:.*/, "M:" + M_type);
  }
  $("#source")["val"](new_abc_content);
  isNew = false;
  src_change();
  doLog();
}

// 更新乐谱 更新(首拍)拍号后重新转换谱内容
function genUpdateStaff(val) {
  console.log('genUpdateStaff:');
  // var abc_content = $("#source")["val"]();
  // console.log('genUpdateStaff abc_content ', abc_content);
  lastMidiReplaceNoteIstart = -1;
  lastMidiReplaceNoteV = -1;
  if (updateStaffPropStatus) {
    updateStaffPropStatus = false;
    updateStaffProp();
    return;
  } 
  // 已更新首拍号，未更新音符
  var abc_content = $("#source")["val"]();
  console.log('genUpdateStaff abc_content ', abc_content);
  // 行转数组
  var abc_content_arr = abc_content["split"]("\x0A"); // "\x0A" == "\\n"
  console.log('genUpdateStaff abc_content_arr ', abc_content_arr);

  var voice_arr = [];
  var voice_notes_obj = {};
  for(var i = 9; i<abc_content_arr.length; i++){
    if(abc_content_arr[i].indexOf('%%score')>-1){
      var v_str = abc_content_arr[i].replace('%%score ', '').replace('{', '').replace('}', '').replace('| ', '');
      vv_arr = v_str.split(' ');
      for(var j = 0; j<vv_arr.length; j++){
        if(vv_arr[j]){
          var v_n = parseInt(vv_arr[j]);
          if(v_n){
            voice_arr.push(v_n);
          }
        }
      }
      // console.log('genUpdateStaff voice_arr', voice_arr);
    }
    if(voice_arr.length){
      for(var j=0; j<voice_arr.length; j++){
        if(abc_content_arr[i].indexOf('V:'+voice_arr[j])>-1){
          voice_notes_obj['V:'+voice_arr[j]] = abc_content_arr[i+1];
        }
      }
    }
  }
  // console.log('genUpdateStaff voice_notes_obj', voice_notes_obj);

  // 获取 head 信息
  var abc_content_head_str = '';
  if(abc_content.indexOf("%%vsetting_end")>-1){
    abc_content_head_str = abc_content.split("%%vsetting_end")[0] + "%%vsetting_end" + "\x0A";
  }else{
    abc_content_head_str = abc_content.split("%%MIDI program 0")[0] + "%%MIDI program 0" + "\x0A";
  }
  console.log('genUpdateStaff abc_content_head_str', abc_content_head_str);

  // 获取全局拍号
  var Meter_list = abc_content_head_str.match(/M\s*:\s*[1-9]\/[1-9]/g);
  var Meter_arr = Meter_list[0].replace('M: ', '').split('/');
  // console.log('genUpdateStaff Meter_arr', Meter_arr);
  
  var barsperstaff = $("#barsperstaff")["val"]();
  voice_notes_obj = resetNodeData(voice_notes_obj, Meter_arr, barsperstaff);

  var new_abc_content = "";
  new_abc_content += abc_content_head_str;
  for(var vt in voice_notes_obj){
    new_abc_content += vt + "\x0A" + voice_notes_obj[vt] + "\x0A";
  }
  console.log('genInitStaff new_abc_content', new_abc_content);
  var M_type = $("#M_type")["val"]();
  if (M_type != "1") {
    new_abc_content = new_abc_content["replace"](/M:.*/, "M:" + M_type);
  }
  $("#source")["val"](new_abc_content);
  isNew = false;
  src_change();
  doLog();
}

// 重组小结
function resetNodeData(voice_notes_obj, Meter_arr, barsperstaff_num, barsperstaff_before_num){
  barsperstaff_before_num = barsperstaff_before_num?barsperstaff_before_num:0;
  // console.log('genUpdateStaff Meter_arr', Meter_arr);
  for(var m=0; m<Meter_arr.length; m++){
    Meter_arr[m] = parseInt(Meter_arr[m]);
  }
  var curr_node_len = parseInt(Meter_arr[0])*8/parseInt(Meter_arr[1]);
  for(var vt in voice_notes_obj){
    console.log('genUpdateStaff voice_notes_obj', voice_notes_obj[vt]);
    var v_node_str = voice_notes_obj[vt];
    var v_node_after_str = '';
    // 先把音符通过拍号拆分,因为中途拍号后不用改变
    var t_Meter_list = v_node_str.match(/\[M\s*:\s*(\d\/\d|C\|?)\]/g);
    if(t_Meter_list){
      var v_node_s_arr = v_node_str.split(t_Meter_list[0]);
      v_node_str = v_node_s_arr[0];
      v_node_after_str = t_Meter_list[0] + v_node_s_arr[1];
    }
    // 去掉 abc 换行号 $ 及小姐符号
    v_node_str = v_node_str.replace(/\$/g, '')
                            .replace(/%V\dline\dend/g, '')
                            .replace(/:\|\|:/g, ' ')
                            .replace(/:\|/g, ' ')
                            .replace(/\|:/g, ' ')
                            .replace(/\.\|/g, ' ')
                            .replace(/\|\]/g, ' ')
                            .replace(/\|\|/g, ' ')
                            .replace(/\|/g, ' ')
                            .replace(/z/g, ' z'); // 休止符与前音符隔开 
    // 音符字符转数组
    var v_node_arr = v_node_str.split(' ');
    // console.log('genUpdateStaff v_node_arr', v_node_arr);
    // for(var i=v_node_arr.length-1; i>-1; i--){
    //   if(v_node_arr[i].match(eval('/z,*'+curr_node_len+'/g'))){
    //     // v_node_arr[i] = ''; // 除去结尾多余的空小节
    //   }else{
    //     break;
    //   }
    // }
    // console.log('genUpdateStaff v_node_arr', v_node_arr);
    var barsperstaff_n = 0;
    var new_node_str = '';
    var temp_new_node_str = '';
    for(var i = 0; i<v_node_arr.length; i++){
      var n_note_str = v_node_arr[i];
      if(temp_new_node_str){
        var temp_str = temp_new_node_str + ' ' + n_note_str;
      }else{
        var temp_str = n_note_str;
      }
      var temp_len = calNodeLen(temp_str);

      // 处理音符--开始
      if(temp_len==curr_node_len){
        // 刚刚好一小节
        new_node_str += temp_str + ' | ';
        // 小节标记
        barsperstaff_n ++;
        if(barsperstaff_n+barsperstaff_before_num==barsperstaff_num){
          new_node_str += '$';
          barsperstaff_n = 0;
          barsperstaff_before_num = 0;
        }
        temp_new_node_str  = '';
      }else if(temp_len<curr_node_len){
        // 小于
        temp_new_node_str = temp_str;
      }else{
        // 大于
        var temp_note_arr = splitNoteStr2(n_note_str, curr_node_len-calNodeLen(temp_new_node_str), curr_node_len);
        if(temp_new_node_str){
          var temp_str = temp_new_node_str + ' ' + temp_note_arr[0];
        }else{
          var temp_str = temp_note_arr[0];
        }
        new_node_str += temp_str + ' | ';
        // 小节标记
        barsperstaff_n ++;
        if(barsperstaff_n+barsperstaff_before_num==barsperstaff_num){
          new_node_str += '$';
          barsperstaff_n = 0;
          barsperstaff_before_num = 0;
        }
        temp_new_node_str = '';
        for(var j=1; j<temp_note_arr.length; j++){
          var temp_str  = temp_note_arr[1];
          if(curr_node_len==calNodeLen(temp_str)){
            new_node_str += temp_str + ' | ';
            // 小节标记
            barsperstaff_n ++;
            if(barsperstaff_n+barsperstaff_before_num==barsperstaff_num){
              new_node_str += '$';
              barsperstaff_n = 0;
              barsperstaff_before_num = 0;
            }
            temp_new_node_str = '';
          }else{
            temp_new_node_str = temp_str;
          }
        }
      }

      // 处理音符--结束
    }
    if(temp_new_node_str){
      // 正常情况时小于小节长度，否则算错
      if(curr_node_len>calNodeLen(temp_new_node_str)){
        var temp_n_len = curr_node_len>calNodeLen(temp_new_node_str);
        new_node_str += temp_new_node_str + ' z,'+ (temp_n_len==1?'':temp_n_len) + ' | ';
        // 小节标记
        barsperstaff_n ++;
        if(barsperstaff_n+barsperstaff_before_num==barsperstaff_num){
          new_node_str += '$';
          barsperstaff_n = 0;
          barsperstaff_before_num = 0;
        }
        temp_new_node_str = '';
      }else{
        console.error('小节组合错误', temp_new_node_str);
      }
    }
    // console.log(new_node_str);
    voice_notes_obj[vt] = new_node_str;
  }
  return voice_notes_obj;
}

// 音符拆分2
function splitNoteStr2(note_str, need_len, curr_node_len, note_arr){
  note_arr = note_arr?note_arr:[]; // 前面拆分音符
  // 处理音符--开始
  var note_str_before = '';
  var note_str_after = '';
  var temp_note_str = note_str;
  var tone_arr = temp_note_str.match(/\[K\:[CDEFGAB][b#]?\]/g); // 匹配调号
  if(tone_arr){
    note_str_before += tone_arr[0]; // 正常情况一个小节一个调号
    for(var i=0; i<tone_arr.length; i++){
      temp_note_str = temp_note_str.replace(tone_arr[i], ''); // 除去调号
    }
  }
  var clef_arr = temp_note_str.match(/\[K\:(treble|bass|alto|tenor)\]/g); // 匹配普号
  if(clef_arr){
    note_str_before += clef_arr[0]; // 正常情况一个音符组最多一个普号
    for(var i=0; i<clef_arr.length; i++){
      temp_note_str = temp_note_str.replace(clef_arr[i], ''); // 除去普号
    }
  }

  var reg_check_after_arr = [
    /\"\d(\-|\~)\]\"/g, // 匹配上下文字
    /\!(\>\)|\<\)|\~\)|coda|segno|D\.C\.(alcoda|alfine)?|D\.S\.(alcoda|alfine)?|fine|tocoda)\!/g, //|渐弱|渐强|gliss|coda|segno|D.C.
  ];

  var reg_check_before_arr = [
    /\!(8va|8vb|15ma|15mb)(\(|\))\!/g, // 匹配高8|15度开始|结束
    /\"!"\"/g, // 匹配歌词
    /\!(\d|pedall|pedall2|ped|ped-up|arpeggio|jpslid|arpeggioup|arpeggiodown|fermata|cresc\.|\>\(|\<\(|\~\(|dim\.|slidelu|slide|sliderd|slideru|sliderd2|\/|\/\/|\/\/\/|pppp|ppp|pp|p|mp|mf|f|ff|fff|ffff|sf|sfz|sff|sfp|fp|fz|strong|sec_strong|weak|kew\d|inst_lingu|inst_pengl|inst_shac|inst_shanjt|inst_shoul|inst_shuanxt|inst_xiangb|inst_xiaojg|inst_feizg|inst_xiaojiao|inst_xiaojiaoxiaoluo|inst_yaoling|inst_wamt|inst_bo|inst_daluo|showsd8|bcb|bc|turn|invertedturn|umrd|mordent|trill|accel|rit|breath|roll|snap|shortphrase|plus|open|emb|tenuto|\>|wedge|\^|upb|dnb|rbr|rbl|lb)\!/g, // 匹配指法|踏板符号|ped-up|ped|arpeggio琵琶凑法|jpslid滑音|arpeggioup|arpeggiodown|（自由）延长符号|cresc.|渐弱|渐强|gliss|dim.|slidelu|slide|sliderd|slideru|sliderd2|/|//震音|///|力度记号|科尔文手势|奥尔夫|回音|逆回音|波音|逆波音|颤音|渐快|渐慢|breath呼吸|shortphrase|roll|snap|plus|open|emb|tenuto|>|wedge|^|upb|dnb|rbr|rbl|lb
    /\[I\:\s*(.*)\]/g, // 方向记号
  ];

  // 除去后无时值修饰符
  for(var i=0; i<reg_check_after_arr.length; i++){
    var res = temp_note_str.match(reg_check_after_arr[i]);
    if(res){
      if(res){
        for(var j=0; j<res.length; j++){
          note_str_after += res[j];
          temp_note_str = temp_note_str.replace(res[j], '');
        }
      }
    }
  }
  // 除去前无时值修饰符
  for(var i=0; i<reg_check_before_arr.length; i++){
    var res = temp_note_str.match(reg_check_before_arr[i]);
    if(res){
      if(res){
        for(var j=0; j<res.length; j++){
          if(reg_check_before_arr[i]+''==(/\!(8va|8vb|15ma|15mb)(\(|\))\!/g)+'' && j==1){
            note_str_after += res[j];
          }else{
            note_str_before += res[j];
          }
          temp_note_str = temp_note_str.replace(res[j], '');
        }
      }
    }
  }
  
  var note_len = calNodeLen(temp_note_str);
  if(note_len!=calNodeLen(note_str)){
    console.error('音符拆分错误', note_str, temp_note_str);
  }

  // 音符、休止符、音符+休止符，3种情况
  // 单音符或单休止符，（如：A, z, x）
  // 多音符：多个独立音符（如： AB），一个组合音符组(如：[AB])
  // 多休止符：如（z,z,2,z,4  x,x,2,x,4,  x,z,2,z,4）(z: 普通休止符，x: 隐藏式休止符)
  // 音符+休止符：如（Az, AzB, [AB]z）

  var is_collection = false;
  if(temp_note_str.match(/\[([A-Ga-gzx](,|')*\d*(\/)*)*\]/g)){
    // 单个音符组
    is_collection = true;
  }
  var note_arr = temp_note_str.match(/[A-Ga-gzx](,|')*/g);
  var note_zs_arr = temp_note_str.match(/\d/g);
  var note_fs_arr = temp_note_str.match(/\//g);
  if(is_collection){
    if(note_arr.length==note_zs_arr.length){
      note_zs_arr = [note_zs_arr[0]];
    }
    if(note_arr.length==note_fs_arr.length){
      note_fs_arr = [note_fs_arr[0]];
    }
  }
  
  // 拆分成音符前后两节（或一节）
  var temp_note_before_after_arr = note_str.split(temp_note_str);

  // 需要长度转换长度转换
  var n_zs = 0; // 整数
  var n_xs = 0; // 小数
  var n_fz = 0; // 分子
  var n_fm = 0; // 分母
  /**
   * 音符说明 1 = 8分音符，乘以或除以2拆分或组合
   * 1*2=4分音符，1/2=16分音符
  **/
  if(need_len>=1){
    n_zs = Math.floor(need_len);
    n_xs = need_len-n_zs;
  }else{
    n_xs = need_len;
  }
  if(n_xs){
    var f_str = fractionConvert(n_xs);
    // n x/y
    var ff_arr = f_str.split(' ');
    var t_zs = 0;
    if(ff_arr.length==2){
      t_zs = parseInt(ff_arr[0]);
      var f_arr = ff_arr[1].split('/');
    }else{
      var f_arr = ff_arr[0].split('/');
    }
    n_fz = parseInt(f_arr[0]);
    n_fm = parseInt(f_arr[1]);
    if(t_zs>0){
      n_fz = t_zs*n_fm;
    }
  }
  // 需要拆出音符大小数据
  var n_fm_str = '';
  var sy_zs = 0;
  var sy_fm_str = '';
  n_fm = n_fm?n_fm:1;
  n_zs = n_zs?n_zs:1;
  var n_fm_str_len = Math.log(n_fm)/Math.log(2);
  for(var i=0; i<n_fm_str_len; i++){
    n_fm_str += '/';
  }

  // 当前要拆分的音符大小数据
  var zs = 0;
  var fm = 0;
  if(note_zs_arr && note_zs_arr.length){
    if(note_zs_arr.length>1){
      console.error('音符拆分错误', note_str, note_zs_arr);
    }
    zs = parseInt(note_zs_arr[0]);
  }
  if(note_fs_arr && note_fs_arr.length){
    fm = Math.pow(2, note_fs_arr.length)
  }
  fm = fm?fm:1;
  zs = zs?zs:1;

  if(fm==n_fm){
    if(fm!=1 && zs!=1){
      if(zs>1 && zs>n_zs){
        // 1/8 * zs * 1/fm -  1/8 * n_zs * 1/n_fm = 1/8 * (zs-n_zs)/n_fm
        sy_zs = zs - n_zs;
        sy_fm_str = n_fm_str;
      }else{
        console.error('音符拆分错误', note_str, note_zs_arr, note_str, need_len, curr_node_len, note_arr, zs, n_zs);
      }
    }
    
  }else if(fm>n_fm){
    var s_len = Math.log(fm)/Math.log(2) - Math.log(n_fm)/Math.log(2);
    // 1/8 * zs * 1/fm -  1/8 * n_zs * 1/n_fm = 1/8 * (zs-n_zs*s_len*2)/n_fm
    sy_zs = zs - n_zs*s_len*2;
    sy_fm_str = n_fm_str;
    for(var i = 0; i<s_len; i++){
      sy_fm_str += '/';
    }
  }else if(fm<n_fm){
    var s_len = Math.log(n_fm)/Math.log(2) - Math.log(fm)/Math.log(2);
    sy_zs = zs*s_len*2 - n_zs;
    sy_fm_str = n_fm_str;
  }
  sy_zs = sy_zs<1?1:sy_zs;

  if(note_arr.length==1){
    // is_collection
    var nt_note_str = note_arr[0];
    var new_note_str = (is_collection?'[':'') + nt_note_str + (n_zs<=1?'':n_zs) + n_fm_str + (is_collection?']-':'');
    var need_note_str = temp_note_before_after_arr[0] + new_note_str + temp_note_before_after_arr[1];
    note_arr.push(need_note_str);
    var sy_temp_note_str = (is_collection?'[':'') + nt_note_str + (sy_zs<=1?'':sy_zs) + sy_fm_str + (is_collection?']':'');
    var sy_note_str = temp_note_before_after_arr[0] + sy_temp_note_str + temp_note_before_after_arr[1];
    if(calNodeLen(sy_note_str)<=curr_node_len){
      note_arr.push(sy_note_str);
      return note_arr;
    }else{
      return splitNoteStr2(sy_note_str, curr_node_len, curr_node_len, note_arr);
    }
  }else if(note_arr.length>1){
    if(is_collection){
      var new_note_str = '[';
      var sy_temp_note_str = '[';
      for(var i = 0; i<note_arr.length; i++){
        new_note_str += note_arr[i] + (n_zs<=1?'':n_zs) + n_fm_str;
        sy_temp_note_str += note_arr[i] + (sy_zs<=1?'':sy_zs) + sy_fm_str;
      }
      new_note_str += ']-';
      sy_temp_note_str += ']';
      var need_note_str = temp_note_before_after_arr[0] + new_note_str + temp_note_before_after_arr[1];
      note_arr.push(need_note_str);
      var sy_note_str = temp_note_before_after_arr[0] + sy_temp_note_str + temp_note_before_after_arr[1];
      if(calNodeLen(sy_note_str)<=curr_node_len){
        note_arr.push(sy_note_str);
        return note_arr;
      }else{
        return splitNoteStr2(sy_note_str, curr_node_len, curr_node_len, note_arr);
      }
    }else{
      var temp_note_arr = temp_note_str.match(/[A-Ga-gzx](,|')*\d*(\/)*/g)
      var new_note_str = '';
      var new_temp_note_str = '';
      var new_note_builded = false;
      var sy_temp_note_str = '';
      temp_note_arr[0] = temp_note_before_after_arr[0] + temp_note_arr[0];
      temp_note_arr[temp_note_arr.length-1] = temp_note_arr[temp_note_arr.length-1] + temp_note_before_after_arr[1];
      for(var i = 0; i<temp_note_arr.length; i++){
        if(new_note_builded){
          sy_temp_note_str += new_note_str;
          if(calNodeLen(sy_temp_note_str)==curr_node_len){
            note_arr.push(sy_temp_note_str);
            sy_temp_note_str = '';
          }else if(calNodeLen(sy_temp_note_str)<curr_node_len){
            
          }else{
            console.error('音符拆分错误', sy_temp_note_str, new_temp_note_arr[j]);
          }
          continue;
        }
        new_temp_note_str += temp_note_arr[i];
        if(calNodeLen(new_temp_note_str)==need_len){
          var need_note_str = new_temp_note_str;
          note_arr.push(need_note_str);
          new_note_builded = true;
        }else if(calNodeLen(new_temp_note_str)>need_len){
          new_temp_note_str = new_note_str;
          var new_temp_note_arr = splitNoteStr2(temp_note_arr[i], need_len-calNodeLen(new_temp_note_str), curr_node_len, []);
          new_temp_note_str += new_temp_note_arr[0];
          var need_note_str = new_temp_note_str;
          note_arr.push(need_note_str);
          new_note_builded = true;
          for(var j=1; j<new_temp_note_arr.length; j++){
            if(calNodeLen(sy_temp_note_str+new_temp_note_arr[j])==curr_node_len){
              note_arr.push(sy_temp_note_str+new_temp_note_arr[j]);
              sy_temp_note_str = '';
            }else if(calNodeLen(sy_temp_note_str+new_temp_note_arr[j])<curr_node_len){
              sy_temp_note_str += new_temp_note_arr[j];
            }else{
              console.error('音符拆分错误', sy_temp_note_str, new_temp_note_arr[j]);
            }
          }
        }else{
          new_note_str += temp_note_arr[i];
        }
      }
      if(sy_temp_note_str){
        note_arr.push(sy_temp_note_str);
      }
      console.log(note_arr);
      return note_arr;
    }
  }else{
    console.error('音符拆分错误', note_str, temp_note_str);
  }
  return [note_arr];
  // 处理音符--结束
}
// -- splitNoteStr2() end

// 小数转分数
function fractionConvert(num) {
  if((num+'').indexOf('.')==-1 || (num+'').indexOf('/')>-1){
    return num;
  }
  let intPart = Math.floor(num);
  let floatPart = num - intPart;
  // 小数化为真分数
  let numerator = floatPart * 100;
  let denominator = 100;
  while (numerator % 10 === 0) {
    numerator /= 10;
    denominator /= 10;
  }
  // 分数化简
  let gcd = function(a, b) {
    return b === 0 ? a : gcd(b, a%b);
  }
  let common = gcd(numerator, denominator);
  numerator /= common;
  denominator /= common;
  // 组合
  let result = '';
  if (intPart !== 0) {
    result += intPart + ' ';
  }
  result += numerator + '/' + denominator;
  return result;
}

function handleBarNum() {
  var _0x15331 = getStaffInfo("source");
  if (!_0x15331) {
    return;
  }
  var node_count = parseInt($("#nodecount")["val"]());
  if (node_count > _0x15331["barCount"]) {
    appendNodes(node_count - _0x15331["barCount"]);
  } else {
    if (node_count < _0x15331["barCount"]) {
      var _0x152CF = [];
      for (
        var _0x11901 = _0x15331["barCount"];
        _0x11901 >= node_count;
        _0x11901--
      ) {
        _0x152CF["push"](_0x11901);
      }
      delNodes(_0x152CF);
    }
  }
}

function handleBreakLine(abc_content, row_bars_count) {
  console.log('handleBreakLine', row_bars_count);
  var lines_info = getLinesInfo(abc_content);
  var new_abc_content = "";
  var check_bar =
    /(\|[1-9\.]+)|(\|\[[1-9\.]+)|(:\|\|:)|(:\|:)|(:\|)|(::)|(\|:)|(\|\|)|(\|\])|(\|)/g;
  var node_count = 0;
  var temp_obj = new Map();
  for ( var i = 0; i < lines_info.length; i++ ) {
    var line_item = lines_info[i];
    if(line_item["type"] == "other" && line_item["lineStr"] == "$"){
      continue;
    }
    if(line_item["type"] == "score"){
      console.log('handleBreakLine score', temp_obj);
      node_count = 0; // 如果是中途转换声部，重新开始计算
      temp_obj = new Map();
    }
    if (parseInt(row_bars_count) < 1) {
      if (line_item["v"] != -1 && line_item["type"] == "note") {
        new_abc_content +=
          line_item["lineStr"]["replace"](/\$/g, "") + "\x0A";
      } else {
        new_abc_content += line_item["lineStr"] + "\x0A";
      }
    } else {
      if (line_item["v"] != -1 && line_item["type"] == "note") {
        if (
          temp_obj.get("count" + line_item["v"]) == null
        ) {
          temp_obj.set("count" + line_item["v"], 0);
        }
        node_count = temp_obj.get("count" + line_item["v"]);
        var lineStr = line_item["lineStr"];
        lineStr = lineStr["replace"](/\$/g, "");
        lineStr = lineStr["replace"](/^\s*/, "");
        lineStr = lineStr["replace"](":||:", ":|:")["replace"](
          "::",
          ":|:"
        );
        var bar_arr = "";
        var s_index = 0;
        var b_str = "";
        while ((bar_arr = check_bar["exec"](lineStr))) {
          if (bar_arr["index"] == 0) {
            continue;
          }
          node_count++;
          b_str +=
            lineStr["substring"](s_index, bar_arr["index"]) +
            bar_arr[0];
          if (node_count % row_bars_count == 0) {
            b_str += "$";
          }
          s_index = bar_arr["index"] + bar_arr[0]["length"];
        }
        b_str += "$"; // 结尾都换一下行
        temp_obj.set("count" + line_item["v"], node_count);
        b_str += lineStr["substring"](s_index, lineStr["length"]);
        new_abc_content += b_str + "\x0A";
      } else {
        if (
          line_item["v"] != -1 &&
          line_item["type"] == "note"
        ) {
          new_abc_content +=
            line_item["lineStr"]["replace"](/\$/g, "") +
            "\x0A";
        } else {
          new_abc_content += line_item["lineStr"] + "\x0A";
        }
      }
    }
  }
  if (new_abc_content["indexOf"]("%%linebreak") < 0) {
    new_abc_content = "%%linebreak $\x0A" + new_abc_content;
  }
  if (parseInt(row_bars_count) < 1) {
    new_abc_content = new_abc_content["replace"]("%%linebreak $\x0A", "");
  }
  new_abc_content = new_abc_content["replace"](/%%barsperstaff.*\n/, "");
  return new_abc_content;
}

function handleBreakLine_bak(abc_content, row_bars_count) {
  var lines_info = getLinesInfo(abc_content);
  var new_abc_content = "";
  var check_bar =
    /(\|[1-9\.]+)|(\|\[[1-9\.]+)|(:\|\|:)|(:\|:)|(:\|)|(::)|(\|:)|(\|\|)|(\|\])|(\|)/g;
  var node_count = 0;
  var temp_obj = new Map();
  for ( var i = 0; i < lines_info.length; i++ ) {
    var line_item = lines_info[i];
    if (parseInt(row_bars_count) < 1) {
      if (line_item["v"] != -1 && line_item["type"] == "note") {
        new_abc_content +=
          line_item["lineStr"]["replace"](/\$/g, "") + "\x0A";
      } else {
        new_abc_content += line_item["lineStr"] + "\x0A";
      }
    } else {
      if (line_item["v"] != -1 && line_item["type"] == "note") {
        if (
          temp_obj["get"]("count" + line_item["v"]) == null
        ) {
          temp_obj["set"]("count" + line_item["v"], 0);
        }
        node_count = temp_obj["get"]("count" + line_item["v"]);
        var lineStr = line_item["lineStr"];
        lineStr = lineStr["replace"](/\$/g, "");
        lineStr = lineStr["replace"](/^\s*/, "");
        lineStr = lineStr["replace"](":||:", ":|:")["replace"](
          "::",
          ":|:"
        );
        var bar_arr = "";
        var s_index = 0;
        var b_str = "";
        while ((bar_arr = check_bar["exec"](lineStr))) {
          if (bar_arr["index"] == 0) {
            continue;
          }
          node_count++;
          b_str +=
            lineStr["substring"](s_index, bar_arr["index"]) +
            bar_arr[0];
          if (node_count % row_bars_count == 0) {
            b_str += "$";
          }
          s_index = bar_arr["index"] + bar_arr[0]["length"];
        }
        temp_obj["set"]("count" + line_item["v"], node_count);
        b_str += lineStr["substring"](s_index, lineStr["length"]);
        new_abc_content += b_str + "\x0A";
      } else {
        if (
          line_item["v"] != -1 &&
          line_item["type"] == "note"
        ) {
          new_abc_content +=
            line_item["lineStr"]["replace"](/\$/g, "") +
            "\x0A";
        } else {
          new_abc_content += line_item["lineStr"] + "\x0A";
        }
      }
    }
  }
  if (new_abc_content["indexOf"]("%%linebreak") < 0) {
    new_abc_content = "%%linebreak $\x0A" + new_abc_content;
  }
  if (parseInt(row_bars_count) < 1) {
    new_abc_content = new_abc_content["replace"]("%%linebreak $\x0A", "");
  }
  new_abc_content = new_abc_content["replace"](/%%barsperstaff.*\n/, "");
  return new_abc_content;
}

function handleBarsPerStaff(_0x13C9B, barsperstaff) {
  var _0x15393 = getBarsArray(_0x13C9B, true);
  var _0x11C11 = "";
  for (var _0x11901 = 1; _0x11901 <= _0x15393["length"]; _0x11901++) {
    if (
      _0x15393[_0x11901 - 1]["replace"](/\s/g, "") != ""
    ) {
      _0x11C11 += _0x15393[_0x11901 - 1];
      if (_0x11901 > 1 && _0x11901 % barsperstaff == 0) {
        _0x11C11 += "$";
      }
    }
  }
  return _0x11C11;
}
function getBarsArray(_0x13C9B, _0x14FBF) {
  if (_0x14FBF) {
    return _0x13C9B["replace"](/::/g, ":|:")
      ["replace"](/\$/g, "")
      ["match"](/.[^\|]*[:]?[|]?\|[:]?[\]]?/g);
  } else {
    return _0x13C9B["replace"](/::/g, ":|:")["match"](
      /.[^\|]*[:]?[|]?\|[:]?[\]]?/g
    );
  }
}
function genVSetting(_0x14CAF) {
  var staff_num = parseInt($("#STAFFNUM")["val"]());
  var _0x11C11 = "%%vsetting_start\x0A";
  var _0x11901 = 1;
  var _0x14C4D = 1;
  var score_str = "";
  if (_0x14CAF) {
    var abc_content = $("#source")["val"]();
    var check_score = /%%score.*|%%staves.*/;
    var _0x13F49 = abc_content["match"](check_score);
    if (_0x13F49 != null) {
      score_str = _0x13F49[0];
    }
  } else {
    score_str = "%%score ";
    for (var _0x11901 = 0; _0x11901 < staff_num; _0x11901++) {
      score_str += _0x11901 + 1 + " ";
    }
  }
  score_str += "\x0A";
  _0x11C11 += score_str;
  $["each"]($(".staffProp"), function (_0x1241B, _0x147B5) {
    _0x11901 = $(_0x147B5)["attr"]("staffnum");
    var _0x14D11 = $("#staffclef" + _0x11901)["val"]();
    var _0x14DD5 = $("#nm" + _0x11901)["val"]();
    var _0x14E37 = $("#snm" + _0x11901)["val"]();
    var _0x14E99 = $("#tone" + _0x11901)["val"]();
    var _0x14D73 = $(".isRhythm[staffnum='" + _0x11901 + "']")["prop"](
      "checked"
    );
    var _0x137A1 = "V:" + _0x14C4D++;
    if (_0x14D11 && _0x14D11 != "") {
      _0x137A1 += " clef=" + _0x14D11;
    } else {
      if (_0x1241B % 2 == 0) {
        _0x137A1 += " treble";
      } else {
        _0x137A1 += " bass";
      }
    }
    if (_0x14D73) {
      _0x137A1 += " perc stafflines=1";
    }
    if (_0x14DD5 && _0x14DD5 != "") {
      _0x137A1 += ' nm="' + _0x14DD5 + '"';
    }
    if (_0x14E37 && _0x14E37 != "") {
      _0x137A1 += ' snm="' + _0x14E37 + '"';
    }
    if (_0x14E99 && _0x14E99 != "") {
      _0x137A1 += "\x0A%%MIDI program " + _0x14E99;
    } else {
      _0x137A1 += "\x0A%%MIDI program 0";
    }
    _0x11C11 += _0x137A1 + "\x0A";
  });
  if (_0x14C4D == 1) {
    for (var _0x11901 = 0; _0x11901 < staff_num; _0x11901++) {
      var _0x14BEB = "";
      if (_0x11901 % 2 == 0) {
        _0x14BEB = "treble";
      } else {
        _0x14BEB = "bass";
      }
      _0x11C11 +=
        "V:" + (_0x11901 + 1) + " " + _0x14BEB + "\x0A";
      _0x11C11 += "%%MIDI program 0\x0A";
    }
  }
  _0x11C11 += "%%vsetting_end\x0A";
  return _0x11C11;
}

function genVSetting2(c) {
  console.log('genVSetting2', content_vue.m.scoreOpts.voiceParts);
  var voiceParts = content_vue.m.scoreOpts.voiceParts;

  var staff_num = voiceParts.length;
  var v_setting_str = "%%vsetting_start\x0A";
  var v_num = 1; // 声部序号
  var score_str = "";
  if (c) {
    var abc_content = $("#source")["val"]();
    var check_score = /%%score.*|%%staves.*/;
    var _0x13F49 = abc_content["match"](check_score);
    if (_0x13F49 != null) {
      score_str = _0x13F49[0];
    }
  } else {
    score_str = "%%score ";
    for (var i = 0; i < staff_num; i++) {
      score_str += i + 1 + " ";
    }
  }
  score_str += "\x0A";
  v_setting_str += score_str;

  
  // 所有声部设置信息
  for(var i=0; i<voiceParts.length; i++){
    var staffclef = voiceParts[i]['clef'];
    var name = voiceParts[i]['name'];
    var subname = voiceParts[i]['subname'];
    var tone = voiceParts[i]['tone'];
    var isRhythm = voiceParts[i]['isRhythm'];

    var tmp_v_setting = "V:" + v_num++;
    if (staffclef && staffclef != "") {
      tmp_v_setting += " clef=" + staffclef;
    } else {
      if (i % 2 == 0) {
        tmp_v_setting += " treble";
      } else {
        tmp_v_setting += " bass";
      }
    }
    if (isRhythm) {
      tmp_v_setting += " perc stafflines=1";
    }
    if (name && name != "") {
      tmp_v_setting += ' nm="' + name + '"';
    }
    if (subname && subname != "") {
      tmp_v_setting += ' snm="' + subname + '"';
    }
    if (tone && tone != "") {
      tmp_v_setting += "\x0A%%MIDI program " + tone;
    } else {
      tmp_v_setting += "\x0A%%MIDI program 0";
    }
    v_setting_str += tmp_v_setting + "\x0A";
  }

  if (v_num == 1) {
    for (var i = 0; i < staff_num; i++) {
      var tmp_v_setting = "";
      if (i % 2 == 0) {
        tmp_v_setting = "treble";
      } else {
        tmp_v_setting = "bass";
      }
      v_setting_str += "V:" + (i + 1) + " " + tmp_v_setting + "\x0A";
      v_setting_str += "%%MIDI program 0\x0A";
    }
  }
  v_setting_str += "%%vsetting_end\x0A";
  return v_setting_str;
}

function genNodesByCount(node_count, beat) {
  // 通过谱面信息计算
  var m = get("M:");
  if(m){
    var m_arr = m.split("/");
    if(m_arr.length==2){
      var top = parseInt(m_arr[0]);
      var bot = parseInt(m_arr[1]);
      var L = get("L:");
      if(L){
        var Larr = L.split("/");
        if(Larr.length==2){
          // var Ltop = parseInt(Larr[0]);
          var Lbot = parseInt(Larr[1]);
          var bs = Lbot/bot;
          var n_str = '';
          for(var i=0; i<top; i++){
            n_str += 'z,' + bs;
          }
          var nn_str = "";
          for (var i = 0; i < node_count; i++) {
            nn_str += " " + n_str + " |";
          }
          return nn_str;
        }
      }
    }
  }
  // 全局设置方式计算
  if (!beat) {
    var beat = new Object();
    beat["top"] = parseInt($("#M_mol").val());
    beat["bot"] = parseInt($("#M_den").val());
  }
  var note_b = new Object(); // 音符单位
  note_b["top"] = parseInt(
    $("#L").val().split("/")[0]
  );
  note_b["bot"] = parseInt(
    $("#L").val().split("/")[1]
  );
  var bs = parseInt(note_b["bot"] / beat["bot"]);
  // var n_str = "z," + bs * beat["top"];
  var n_str = '';
  for(var i=0; i<beat["top"]; i++){
    n_str += 'z,' + bs;
  }
  var nn_str = "";
  for (var i = 0; i < node_count; i++) {
    nn_str += " " + n_str + " |";
  }
  return nn_str;
}
function updateStaffProp() {
  console.log('updateStaffProp');
  var abc_content = $("#source")["val"]();
  var v_setting = genVSetting(true);
  console.log('updateStaffProp genVSetting', v_setting);
  var m_str = /%%vsetting_start[\s\S]*%%vsetting_end\n/;
  var m_arr = abc_content["match"](m_str);
  if (m_arr != null) {
    abc_content = abc_content["replace"](m_arr[0], v_setting);
    $("#source")["val"](abc_content);
    src_change();
  }
}

// 更新声部设置信息
function updateStaffProp2() {
  console.log('updateStaffProp2');

  var staff_info = getStaffInfo("source");
  var staff_num = content_vue.m.scoreOpts.voiceParts.length;
  if (staff_num != staff_info["vocalCount"]) {
    handleStaffChange2();
  }

  var abc_content = $("#source").val();
  var v_setting = genVSetting2(true);
  console.log('updateStaffProp2 genVSetting', v_setting);
  var m_str = /%%vsetting_start[\s\S]*%%vsetting_end\n/;
  var m_arr = abc_content.match(m_str);
  // console.log('updateStaffProp2', m_arr);
  // console.log('updateStaffProp2', abc_content);
  if (m_arr != null) {
    abc_content = abc_content["replace"](m_arr[0], v_setting);
    // console.log(abc_content);
    $("#source")["val"](abc_content);
    src_change();
  }
  switchRhythm2();
}

// 设置节奏谱
function switchRhythm2() {
  console.log('switchRhythm2');
  var voiceParts = content_vue.m.scoreOpts.voiceParts;
  var abc_content = '';
  for(var i=0; i<voiceParts.length; i++){
    abc_content = switchRhythmContent2(voiceParts[i].isRhythm, i+1, abc_content);
  }
  $("#source").val(abc_content);
  src_change();
  doLog();
}
function switchRhythmContent2(isRhythm, staff_num, abc_content) {
  if(!abc_content){
    var abc_content = $("#source").val();
  }
  var v_reg = new RegExp("V:\\s*" + staff_num + ".*", "g");
  // console.log('switchRhythm2', v_reg);
  var v_arr = abc_content.match(v_reg);
  // console.log('switchRhythm2', v_reg);
  if (v_arr != null) {
    for (var i = 0; i < v_arr.length; i++) {
      var ac_abc_content = v_arr[i];
      if (isRhythm) {
        abc_content = abc_content.replace(ac_abc_content, ac_abc_content + " perc stafflines=1");
      } else {
        abc_content = abc_content.replace(
          ac_abc_content,
          ac_abc_content.replace("perc stafflines=1", "")
        );
      }
    }
  }
  return abc_content;
}

function appendNodes(num) {
  // var staff_num = parseInt($("#STAFFNUM")["val"]());
  var abc_content = $("#source")["val"]();
  var add_content = genNodesByCount(num);
  var lines_info = getLinesInfo(abc_content);
  // var bar_reg = /(\|[1-9\.]+)|(\|\[[1-9\.]+)|(:\|\|:)|(:\|:)|(:\|)|(::)|(\|:)|(\|\|)|(\|\])|(\|)/g;
  var node_count = 0;
  var new_abc_content = "";
  var v_obj = new Map();
  var n_num = 0;
  for ( var i = lines_info["length"] - 1; i > 0; i-- ) {
    var line_info = lines_info[i];
    if (line_info["type"] == "note") {
      if (v_obj["get"]("key" + line_info["v"]) == null) {
        v_obj["set"]("key" + line_info["v"], true);
        line_info["lineStr"] = line_info["lineStr"]["replace"](
          /(.*\|)/,
          "$1" + add_content
        );
      }
      n_num++;
    }
  }
  var new_abc_content = "";
  for ( var i = 0; i < lines_info["length"]; i++ ) {
    var line_info = lines_info[i];
    new_abc_content += line_info["lineStr"] + "\x0A";
  }
  if (n_num == 0) {
    new_abc_content += "\x0A" + add_content;
  }
  // var barsperstaff = $("#barsperstaff")["val"]();
  new_abc_content = replaceBlankLine(new_abc_content);
  $("#source")["val"](new_abc_content);
  changeLineBars();
  src_change();
  doLog();
}

function popAppendNode() {
  $("#APPEND_NODE_div .modal-content")["css"](
    "left",
    ($(window)["width"]() - $("#APPEND_NODE_div .modal-content")["width"]()) / 2
  );
  $("#APPEND_NODE_div .modal-content")["css"]("width", "250px");
  $("#APPEND_NODE_div")["modal"]();
}
function handleAppendNodes() {
  var _0x12293 = $("#appendNodeNum")["val"]();
  appendNodes(_0x12293);
}
function handleStaffChange() {
  var _0x11A89 = getLinesInfo($("#source")["val"]());
  var _0x15331 = getStaffInfo("source");
  var _0x156A3 = parseInt($("#STAFFNUM")["val"]());
  var new_abc_content = "";
  var _0x1557D = [];
  var _0x1551B = [];
  if (_0x156A3 > _0x15331["vocalCount"]) {
    var _0x155DF = "";
    for (
      var _0x11901 = _0x15331["vocalCount"] + 1;
      _0x11901 <= _0x156A3;
      _0x11901++
    ) {
      _0x1551B["push"](_0x11901);
      _0x155DF += getNewStaffStr(_0x11901, _0x15331["barCount"]);
    }
    var new_abc_content = $("#source")["val"]() + _0x155DF;
    new_abc_content = replaceBlankLine(new_abc_content);
  } else {
    if (_0x156A3 < _0x15331["vocalCount"]) {
      for (
        var _0x11901 = _0x15331["vocalCount"];
        _0x11901 > _0x156A3;
        _0x11901--
      ) {
        _0x1557D["push"](_0x11901);
      }
      for (var _0x11901 = 0; _0x11901 < _0x11A89["length"]; _0x11901++) {
        var _0x12541 = _0x11A89[_0x11901];
        if (_0x1557D["indexOf"](_0x12541["v"] + 1) < 0) {
          if (_0x12541["type"] == "v") {
            if (_0x1557D["indexOf"](_0x12541["vNum"] + 1) < 0) {
              new_abc_content += _0x12541["lineStr"] + "\x0A";
            }
          } else {
            new_abc_content += _0x12541["lineStr"] + "\x0A";
          }
        }
      }
      new_abc_content = replaceBlankLine(new_abc_content);
    }
  }
  var check_score = /%%score|%%staves/;
  $("#source")["val"](new_abc_content);
  _0x11A89 = getLinesInfo($("#source")["val"]());
  var _0x11C11 = "";
  for (var _0x11901 = 0; _0x11901 < _0x11A89["length"]; _0x11901++) {
    var _0x12541 = _0x11A89[_0x11901];
    var _0x11AEB = _0x12541["lineStr"];
    var _0x13F49 = _0x11AEB["match"](check_score);
    if (_0x13F49 != null) {
      var score_str = _0x13F49[0];
      if (_0x1557D > 0) {
        for (var _0x11963 = 0; _0x11963 < _0x1557D["length"]; _0x11963++) {
          _0x11AEB = _0x11AEB["replace"](_0x1557D[_0x11963], "");
        }
      } else {
        if (_0x1551B > 0) {
          var _0x15641 = "";
          for (var _0x11963 = 0; _0x11963 < _0x1551B["length"]; _0x11963++) {
            _0x15641 += " " + _0x1551B[_0x11963];
          }
          _0x11AEB += _0x15641;
        }
      }
    }
    _0x11C11 += _0x11AEB + "\x0A";
  }
  $("#source")["val"](_0x11C11);
  src_change(doLog);
}

// 更新谱表数
function handleStaffChange2() {
  console.log('handleStaffChange2', content_vue.m.scoreOpts.voiceParts);
  var lines_info = getLinesInfo($("#source").val());
  var staff_info = getStaffInfo("source");
  var staff_num = content_vue.m.scoreOpts.voiceParts.length;
  var new_abc_content = "";
  var o_staff_index_arr = [];
  var staff_index_arr = [];
  if (staff_num > staff_info["vocalCount"]) {
    // 添加
    var add_abc_content = "";
    for (
      var i = staff_info["vocalCount"] + 1;
      i <= staff_num;
      i++
    ) {
      staff_index_arr.push(i);
      add_abc_content += getNewStaffStr(i, staff_info["barCount"]);
    }
    var new_abc_content = $("#source").val() + add_abc_content;
    new_abc_content = replaceBlankLine(new_abc_content);
  } else {
    // 删除最底部声部
    if (staff_num < staff_info["vocalCount"]) {
      for (
        var i = staff_info["vocalCount"];
        i > staff_num;
        i--
      ) {
        o_staff_index_arr["push"](i);
      }
      for (var j = 0; j < lines_info["length"]; j++) {
        var line_info = lines_info[j];
        if (o_staff_index_arr["indexOf"](line_info["v"] + 1) < 0) {
          if (line_info["type"] == "v") {
            if (o_staff_index_arr["indexOf"](line_info["vNum"] + 1) < 0) {
              new_abc_content += line_info["lineStr"] + "\x0A";
            }
          } else {
            new_abc_content += line_info["lineStr"] + "\x0A";
          }
        }
      }
      new_abc_content = replaceBlankLine(new_abc_content);
    }
  }
  var check_score = /%%score|%%staves/;
  $("#source").val(new_abc_content);
  // 更新 score 里的声部参数
  lines_info = getLinesInfo($("#source").val());
  var new_abc_content = "";
  for (var n = 0; n < lines_info.length; n++) {
    var line_info = lines_info[n];
    var line_str = line_info["lineStr"];
    var score_arr = line_str.match(check_score);
    if (score_arr != null) {
      // var score_str = score_arr[0];
      if (o_staff_index_arr > 0) {
        for (var m = 0; m < o_staff_index_arr.length; m++) {
          line_str = line_str.replace(o_staff_index_arr[m], "");
        }
      } else {
        if (staff_index_arr.length > 0) {
          var v_str = "";
          for (var m = 0; m < staff_index_arr.length; m++) {
            v_str += " " + staff_index_arr[m];
          }
          line_str += v_str;
        }
      }
      console.log(line_str);
      var v_arr = line_str.match(/\d/g);
      if(v_arr && v_arr.length>1){
         // 声部括号 {} 通常是大谱表，同乐器[] 简谱或重奏不同乐器
        if(v_arr.length==2 && content_vue && content_vue.m && content_vue.m.scoreOpts && content_vue.m.scoreOpts.musicType=='big'){
          line_str = `%%score {${v_arr.join(' ')}}`;
        }else{
          line_str = `%%score [${v_arr.join(' ')}]`;
        }
      }else if(v_arr && v_arr.length==1){
        line_str = `%%score ${v_arr[0]}`;
      }
      console.log(line_str);
    }
    new_abc_content += line_str + "\x0A";
  }
  $("#source").val(new_abc_content);
  src_change(doLog);
}

function getNewStaffStr(_0x150E5, _0x15021) {
  var _0x137A1 = "\x0AV:" + _0x150E5 + " treble\x0A";
  var _0x15083 = genNodesByCount(_0x15021);
  return _0x137A1 + _0x15083 + "\x0A";
}
function addBr(barIndex) {
  console.log('addBr');
  var _0x1183D = $("#btnAddBr")["html"]();
  if (_0x1183D == "\u53d6\u6d88\u6362\u884c") {
    cancelBr();
    return;
  }
  var _0x117DB = $("#nodeMenu")["attr"]("barIndex");
  if (!_0x117DB && !barIndex) {
    return;
  }
  _0x117DB = barIndex?parseInt(barIndex):parseInt(_0x117DB);
  var abc_content = $("#source")["val"]();
  abc_content = abc_content["replace"](/%%barsperstaff.*\n/, "");
  var _0x11A89 = getNodesInfo(abc_content);
  var _0x11C11 = "";
  var _0x11C73 = getSelectedBarInfo(_0x117DB, 0);
  if (_0x11C73["isLineFirstNode"]) {
    _0x117DB--;
    for (
      var _0x11901 = 0, _0x119C5 = _0x11A89["length"];
      _0x11901 < _0x119C5;
      _0x11901++
    ) {
      var _0x11A27 = _0x11A89[_0x11901];
      var _0x11AEB = _0x11A27["lineStr"];
      var _0x11B4D = "";
      if (_0x11A27["type"] == "note") {
        for (
          var _0x11963 = 0;
          _0x11963 < _0x11A27["nodes"]["length"];
          _0x11963++
        ) {
          var _0x11BAF = _0x11A27["nodes"][_0x11963];
          if (_0x11BAF["nodeIndex"] == _0x117DB) {
            _0x11B4D += _0x11BAF["nodeStr"] + "$";
          } else {
            _0x11B4D += _0x11BAF["nodeStr"];
          }
          lastNodeEndSeq = _0x11BAF["endSeq"];
        }
        _0x11B4D += abc_content["substring"](
          lastNodeEndSeq,
          _0x11A27["endSeq"]
        );
        _0x11C11 += _0x11B4D + "\x0A";
      } else {
        _0x11C11 += _0x11A27["lineStr"] + "\x0A";
      }
    }
    _0x11C11 = replaceBlankLine(_0x11C11);
    $("#source")["val"](_0x11C11);
    doLog();
    src_change();
    return;
  }
  for (
    var _0x11901 = 0, _0x119C5 = _0x11A89["length"];
    _0x11901 < _0x119C5;
    _0x11901++
  ) {
    var _0x11A27 = _0x11A89[_0x11901];
    var _0x11AEB = _0x11A27["lineStr"];
    var _0x11B4D = "";
    if (_0x11A27["type"] == "note") {
      for (
        var _0x11963 = 0;
        _0x11963 < _0x11A27["nodes"]["length"];
        _0x11963++
      ) {
        var _0x11BAF = _0x11A27["nodes"][_0x11963];
        if (_0x11BAF["nodeIndex"] == _0x117DB) {
          _0x11B4D += "$" + _0x11BAF["nodeStr"];
        } else {
          _0x11B4D += _0x11BAF["nodeStr"];
        }
        lastNodeEndSeq = _0x11BAF["endSeq"];
      }
      _0x11B4D += abc_content["substring"](lastNodeEndSeq, _0x11A27["endSeq"]);
      _0x11C11 += _0x11B4D + "\x0A";
    } else {
      _0x11C11 += _0x11A27["lineStr"] + "\x0A";
    }
  }
  _0x11C11 = replaceBlankLine(_0x11C11);
  $("#source")["val"](_0x11C11);
  doLog();
  src_change();
}
function cancelBr() {
  var _0x117DB = $("#nodeMenu")["attr"]("barIndex");
  if (!_0x117DB) {
    return;
  }
  _0x117DB = parseInt(_0x117DB);
  var abc_content = $("#source")["val"]();
  var _0x11A89 = getNodesInfo(abc_content);
  var _0x11C11 = "";
  var _0x12ED3 = getPreBarInfo(_0x117DB, 0);
  if (_0x12ED3["nextBr"]) {
    _0x117DB--;
    for (
      var _0x11901 = 0, _0x119C5 = _0x11A89["length"];
      _0x11901 < _0x119C5;
      _0x11901++
    ) {
      var _0x11A27 = _0x11A89[_0x11901];
      var _0x11AEB = _0x11A27["lineStr"];
      var _0x11B4D = "";
      if (_0x11A27["type"] == "note") {
        var _0x12E71 = false;
        for (
          var _0x11963 = 0;
          _0x11963 < _0x11A27["nodes"]["length"];
          _0x11963++
        ) {
          var _0x11BAF = _0x11A27["nodes"][_0x11963];
          if (_0x11BAF["nodeIndex"] == _0x117DB) {
            _0x12E71 = true;
          }
          _0x11B4D += _0x11BAF["nodeStr"];
          lastNodeEndSeq = _0x11BAF["endSeq"];
        }
        if (_0x12E71) {
          _0x11B4D += abc_content["substring"](
            lastNodeEndSeq,
            _0x11A27["endSeq"]
          )["replace"]("$", "");
        } else {
          _0x11B4D += abc_content["substring"](
            lastNodeEndSeq,
            _0x11A27["endSeq"]
          );
        }
        _0x11C11 += _0x11B4D + "\x0A";
      } else {
        _0x11C11 += _0x11A27["lineStr"] + "\x0A";
      }
    }
    _0x11C11 = replaceBlankLine(_0x11C11);
    $("#source")["val"](_0x11C11);
    doLog();
    src_change();
    return;
  }
  for (
    var _0x11901 = 0, _0x119C5 = _0x11A89["length"];
    _0x11901 < _0x119C5;
    _0x11901++
  ) {
    var _0x11A27 = _0x11A89[_0x11901];
    var _0x11AEB = _0x11A27["lineStr"];
    var _0x11B4D = "";
    if (_0x11A27["type"] == "note") {
      var _0x12E71 = false;
      for (
        var _0x11963 = 0;
        _0x11963 < _0x11A27["nodes"]["length"];
        _0x11963++
      ) {
        var _0x11BAF = _0x11A27["nodes"][_0x11963];
        if (_0x11BAF["nodeIndex"] == _0x117DB) {
          _0x12E71 = true;
          _0x11B4D += _0x11BAF["nodeStr"]["replace"](
            "$",
            ""
          );
        } else {
          _0x11B4D += _0x11BAF["nodeStr"];
        }
        lastNodeEndSeq = _0x11BAF["endSeq"];
      }
      if (_0x12E71) {
        _0x11B4D += abc_content["substring"](
          lastNodeEndSeq,
          _0x11A27["endSeq"]
        );
      }
      _0x11C11 += _0x11B4D + "\x0A";
    } else {
      _0x11C11 += _0x11A27["lineStr"] + "\x0A";
    }
  }
  _0x11C11 = replaceBlankLine(_0x11C11);
  $("#source")["val"](_0x11C11);
  doLog();
  src_change();
}
function switchNoteBr() {
  if ($("#notebr")["prop"]("checked")) {
    addBr();
  } else {
    cancelBr();
  }
}
function getPreBarInfo(_0x117DB, _0x15147) {
  return getSelectedBarInfo(_0x117DB - 1, _0x15147);
}
function getSelectedBarInfo(_0x117DB, _0x15147) {
  var abc_content = $("#source")["val"]();
  var _0x11A89 = getNodesInfo(abc_content);
  for (
    var _0x11901 = 0, _0x119C5 = _0x11A89["length"];
    _0x11901 < _0x119C5;
    _0x11901++
  ) {
    var _0x11A27 = _0x11A89[_0x11901];
    var _0x11AEB = _0x11A27["lineStr"];
    if (
      _0x11A27["v"] == _0x15147 &&
      _0x11A27["type"] == "note"
    ) {
      var _0x125A3 = _0x11A27["nodes"];
      for (var _0x11963 = 0; _0x11963 < _0x125A3["length"]; _0x11963++) {
        var _0x11BAF = _0x125A3[_0x11963];
        if (_0x11BAF["nodeIndex"] == _0x117DB) {
          return _0x11BAF;
        }
      }
    }
  }
  return null;
}
function getSelectBarContent(_0x117DB, _0x15147) {
  var abc_content = $("#source")["val"]();
  var _0x11A89 = getNodesInfo(abc_content);
  for (
    var _0x11901 = 0, _0x119C5 = _0x11A89["length"];
    _0x11901 < _0x119C5;
    _0x11901++
  ) {
    var _0x11A27 = _0x11A89[_0x11901];
    var _0x11AEB = _0x11A27["lineStr"];
    if (
      _0x11A27["v"] == _0x15147 &&
      _0x11A27["type"] == "note"
    ) {
      var _0x125A3 = _0x11A27["nodes"];
      for (var _0x11963 = 0; _0x11963 < _0x125A3["length"]; _0x11963++) {
        var _0x11BAF = _0x125A3[_0x11963];
        if (_0x11BAF["nodeIndex"] == _0x117DB) {
          return _0x11BAF["nodeStr"];
        }
      }
    }
  }
}
function delNode(_0x117DB) {
  var _0x13D5F = $("#STAFFNUM")["val"]();
  var abc_content = $("#source")["val"]();
  for (var _0x11901 = 0; _0x11901 < parseInt(_0x13D5F); _0x11901++) {
    var _0x12357 = new RegExp(
      ".*%V" + (_0x11901 + 1) + "lined+(end)?",
      "g"
    );
    var _0x13CFD = new RegExp("%V" + v + "(line\\d+|end)");
    var _0x11A89 = abc_content["match"](_0x12357);
    if (_0x11A89 != null) {
      var _0x13C9B = "";
      for (
        var _0x11963 = 0, _0x119C5 = _0x11A89["length"];
        _0x11963 < _0x119C5;
        _0x11963++
      ) {
        _0x13C9B += _0x11A89[_0x11901]["replace"](_0x13CFD, "");
      }
      if (_0x13C9B != "") {
        getBarsArray(_0x13C9B, false);
      }
    }
  }
}
function upDownKeyWord(_0x184F5) {
  var _0x13E85 = $("svg[type='rectnode'],svg[type='rectbar']");
  var abc_content = $("#source")["val"]();
  if (_0x13E85["length"] > 0) {
    var _0x17ED5 = new Array();
    $["each"]($(_0x13E85), function (_0x11901, _0x147B5) {
      var _0x12605 = $(_0x147B5)["attr"]("id");
      var _0x14F5D = _0x12605["replace"]("mysvgnode", "")[
        "replace"
      ]("mysvgbar", "");
      var _0x1778F, _0x15147;
      if (_0x14F5D["indexOf"]("_") > -1) {
        _0x1778F = parseInt(_0x14F5D["split"]("_")[1]);
        _0x15147 = parseInt(_0x14F5D["split"]("_")[0]);
      } else {
        _0x1778F = parseInt(_0x14F5D);
        _0x15147 = -1;
      }
      var _0x1272B = new Object();
      _0x1272B["barNum"] = _0x1778F;
      _0x1272B["v"] = _0x15147;
      _0x17ED5["push"](_0x1272B);
    });
    if (_0x17ED5["length"] > 0) {
      var _0x11A89 = getNodesInfo(abc_content);
      var _0x12B61 =
        /(\|[1-9\.]+)|(\|\[[1-9\.]+)|(:\|\|:)|(:\|:)|(:\|)|(::)|(\|:)|(\|\|)|(\|\])|(\|)/g;
      var node_count = 0;
      var _0x11C11 = "";
      var _0x12AFF = new Map();
      for (
        var _0x11901 = 0, _0x119C5 = _0x11A89["length"];
        _0x11901 < _0x119C5;
        _0x11901++
      ) {
        var _0x11A27 = _0x11A89[_0x11901];
        var _0x11AEB = _0x11A27["lineStr"];
        var _0x11B4D = "";
        if (_0x11A27["type"] == "note") {
          var _0x125A3 = _0x11A27["nodes"];
          var _0x18493 = false;
          var _0x1867D = _0x11A27["endSeq"];
          var _0x18741 = -1;
          for (var _0x1241B = 0; _0x1241B < _0x125A3["length"]; _0x1241B++) {
            var _0x11BAF = _0x125A3[_0x1241B];
            var _0x18A51 = false;
            var _0x18AB3 = "";
            for (
              var _0x185B9 = 0;
              _0x185B9 < _0x17ED5["length"];
              _0x185B9++
            ) {
              var _0x183CF = _0x17ED5[_0x185B9];
              if (
                (_0x11BAF["v"] == _0x183CF["v"] ||
                  _0x183CF["v"] == -1) &&
                _0x11BAF["nodeIndex"] == _0x183CF["barNum"]
              ) {
                _0x18AB3 = updownnote(_0x11BAF["nodeStr"], _0x184F5);
                _0x18A51 = true;
                _0x18493 = true;
              }
            }
            _0x18741 = _0x11BAF["endSeq"];
            if (!_0x18A51) {
              _0x11B4D += _0x11BAF["nodeStr"];
            } else {
              _0x11B4D += _0x18AB3;
            }
          }
          if (_0x18741 < _0x1867D) {
            _0x11B4D += abc_content["substring"](_0x18741, _0x1867D);
          }
          if (_0x18493) {
            _0x11C11 += _0x11B4D + "\x0A";
          } else {
            _0x11C11 += _0x11AEB + "\x0A";
          }
        } else {
          _0x11C11 += _0x11A27["lineStr"] + "\x0A";
        }
      }
    }
    _0x11C11 = replaceBlankLine(_0x11C11);
    $("#source")["val"](_0x11C11);
    src_change();
    doLog();
    return true;
  }
  if ($(".selected_text")["length"] > 1 || $(".select_text_g")["length"] > 1) {
    var _0x18805 = abc_content + "";
    var new_abc_content = "";
    var _0x1305B = 0;
    var _0x1861B = 0;
    var _0x18557 = 0;
    var _0x1892B = [];
    $(".selected_text,.select_text_g")["each"](function (_0x11901, _0x147B5) {
      var _0x12FF9 = -1;
      _0x12FF9 = $(_0x147B5)["attr"]("istart");
      if (_0x12FF9 == -1) {
        return false;
      }
      var _0x13245 = syms[_0x12FF9];
      update_note_index = 0;
      if (_0x13245 && _0x13245["notes"]["length"] > 1) {
        var _0x18B15 = _0x18805["substring"](
          _0x13245["istart"],
          _0x13245["iend"]
        );
        var _0x11BAF = /\[(.[^\[]*)\]/["exec"](_0x18B15);
        if (_0x11BAF != null) {
          var _0x137A1 = _0x11BAF[1];
          var _0x18431 = str2notes(_0x137A1);
          var _0x18BD9 = "";
          for (var _0x1241B = 0; _0x1241B < _0x18431["length"]; _0x1241B++) {
            _0x18BD9 += _0x18431[_0x1241B]["note"];
          }
          abc_content =
            abc_content["substring"](0, _0x13245["istart"]) +
            "[" +
            _0x18BD9 +
            _0x18B15["substring"](_0x18B15["indexOf"]("]")) +
            abc_content["substring"](_0x13245["iend"]);
          $("#source")["val"](abc_content);
          update_note_index = $(_0x147B5)["attr"]("update_index");
          if (
            update_note_index == -1 &&
            $(_0x147B5)["hasClass"]("select_text_g")
          ) {
            update_note_index = $(_0x147B5)
              ["children"](":first")
              ["attr"]("update_index");
          }
          update_note_index_arr["push"](update_note_index);
          update_note_istart_arr["push"](_0x13245["istart"]);
          var _0x18C3B = _0x18431[update_note_index];
          var _0x189EF = _0x18431[update_note_index]["note"];
          console["log"](
            "update_note_index:",
            update_note_index,
            " \u5f53\u524d\u66f4\u65b0\u7684\u97f3\u7b26\uff1a",
            _0x18431[update_note_index]
          );
          var _0x187A3 = _0x18C3B["index"] + _0x184F5;
          var _0x186DF = updownnote(_0x189EF, _0x184F5);
          console["log"]("\u66f4\u65b0\u524d\u7684\u97f3\u7b26\uff1a", _0x189EF, "  \u66f4\u65b0\u540e:", _0x186DF);
          _0x18557 += _0x186DF["length"] - _0x189EF["length"];
          var _0x1272B = new Object();
          var _0x18B77 = false;
          for (var _0x11963 = 0; _0x11963 < _0x1892B["length"]; _0x11963++) {
            var _0x14F5D = _0x1892B[_0x11963];
            if (_0x14F5D["istart"] == _0x13245["istart"]) {
              _0x1272B = _0x1892B[_0x11963];
              _0x18B77 = true;
            }
          }
          if (_0x18B77) {
            _0x1272B["oldNoteStrArr"]["push"](_0x189EF);
            _0x1272B["newNoteStrArr"]["push"](_0x186DF);
            _0x1272B["updateIndexArr"]["push"](parseInt(update_note_index));
          } else {
            _0x1272B["istart"] = _0x13245["istart"];
            _0x1272B["iend"] = _0x13245["iend"];
            _0x1272B["chordNotes"] = []["concat"](_0x18431);
            _0x1272B["oldNoteStrArr"] = [];
            _0x1272B["oldNoteStrArr"]["push"](_0x189EF);
            _0x1272B["newNoteStrArr"] = [];
            _0x1272B["newNoteStrArr"]["push"](_0x186DF);
            _0x1272B["updateIndexArr"] = [];
            _0x1272B["updateIndexArr"]["push"](parseInt(update_note_index));
            _0x1892B["push"](_0x1272B);
          }
          return true;
        }
      }
      var _0x187A3 = mypit2mid(_0x13245, 0) + _0x184F5;
      play_note(_0x187A3, durSetting);
      update_note_istart_arr["push"](parseInt(_0x12FF9) + _0x18557);
      if (!_0x13245) {
        return;
      }
      var _0x18867 = abc_content["substring"](
        _0x13245["istart"],
        _0x13245["iend"]
      );
      var _0x182A9 = str2notes(_0x18867["replace"](/[\[\]]/g, ""));
      console["log"]("\u5f53\u524d\u4fee\u6539\u7684\u97f3\u7b26\u662f\uff1a", _0x182A9[update_note_index]);
      updateNoteIndexInChord = update_note_index;
      if (!_0x182A9[update_note_index]) {
        return;
      }
      var _0x189EF = _0x182A9[update_note_index]["note"];
      var _0x186DF = updownnote(_0x189EF, _0x184F5);
      var _0x178B5 = _0x18867["replace"](_0x189EF, _0x186DF);
      console["log"]("newNoteStr:", _0x178B5);
      _0x18557 += _0x178B5["length"] - _0x18867["length"];
      new_abc_content +=
        abc_content["substring"](_0x1861B, _0x13245["istart"]) + _0x178B5;
      _0x1305B = _0x13245["istart"];
      _0x1861B = _0x13245["iend"];
    });
    if (_0x1892B["length"] > 0) {
      for (var _0x11901 = 0; _0x11901 < _0x1892B["length"]; _0x11901++) {
        var _0x1272B = _0x1892B[_0x11901];
        var _0x18431 = _0x1272B["chordNotes"];
        var _0x18867 = abc_content["substring"](
          _0x1272B["istart"],
          _0x1272B["iend"]
        );
        var _0x13181 = _0x18867["substring"](
          0,
          _0x18867["indexOf"]("[") + 1
        );
        var _0x16EC1 = _0x18867["substring"](
          _0x18867["indexOf"]("]")
        );
        var _0x186DF = "";
        for (var _0x11963 = 0; _0x11963 < _0x18431["length"]; _0x11963++) {
          var _0x188C9 = false;
          var _0x14753 = "";
          for (
            var _0x1241B = 0;
            _0x1241B < _0x1272B["updateIndexArr"]["length"];
            _0x1241B++
          ) {
            var _0x1898D = _0x1272B["updateIndexArr"][_0x1241B];
            if (_0x1898D == _0x11963) {
              _0x188C9 = true;
              _0x14753 = _0x1272B["newNoteStrArr"][_0x1241B];
            }
          }
          if (_0x188C9) {
            _0x186DF += _0x14753;
          } else {
            _0x186DF += _0x18431[_0x11963]["note"];
          }
        }
        if (_0x186DF != "") {
          _0x186DF = _0x13181 + _0x186DF + _0x16EC1;
          console["log"]("newNoteStr:", _0x186DF);
          new_abc_content =
            abc_content["substring"](0, _0x1272B["istart"]) +
            _0x186DF +
            abc_content["substring"](_0x1272B["iend"]);
        }
      }
      $("#source")["val"](new_abc_content);
      lastFirstNoteSeq = getFirstNoteSeq();
      src_change();
      doLog();
      return true;
    }
    if (new_abc_content != "") {
      new_abc_content += abc_content["substring"](_0x1861B);
      $("#source")["val"](new_abc_content);
      lastFirstNoteSeq = getFirstNoteSeq();
      src_change();
      doLog();
      return true;
    }
  }
  if ($(".selected_text")["length"] == 1 || $(".select_text_g")["length"] == 1) {
    var _0x12FF9 = -1;
    if ($(".selected_text")["length"] > 0) {
      _0x12FF9 = $(".selected_text")["attr"]("istart");
    } else {
      if ($(".select_text_g")["length"] > 0) {
        _0x12FF9 = $("g[istart]")["attr"]("istart");
      }
    }
    if (_0x12FF9 == -1) {
      return false;
    }
    var _0x13245 = syms[_0x12FF9];
    var _0x187A3 = mypit2mid(_0x13245, 0) + _0x184F5;
    play_note(_0x187A3, durSetting);
    var abc_content = $("#source")["val"]();
    update_note_index = 0;
    if (_0x13245 && _0x13245["notes"]["length"] > 1) {
      update_note_index = $(".select_text_g,.selected_text")["attr"]("update_index");
    }
    update_note_istart = _0x12FF9;
    if (!_0x13245) {
      return;
    }
    var _0x18867 = abc_content["substring"](
      _0x13245["istart"],
      _0x13245["iend"]
    );
    var _0x182A9 = str2notes(_0x18867["replace"](/[\[\]]/g, ""));
    console["log"]("\u5f53\u524d\u4fee\u6539\u7684\u97f3\u7b26\u662f\uff1a", _0x182A9[update_note_index]);
    updateNoteIndexInChord = update_note_index;
    if (!_0x182A9[update_note_index]) {
      return;
    }
    var _0x189EF = _0x182A9[update_note_index]["note"];
    var _0x186DF = updownnote(_0x189EF, _0x184F5);
    var _0x178B5 = _0x18867["replace"](_0x189EF, _0x186DF);
    console["log"]("newNoteStr:", _0x178B5);
    var new_abc_content =
      abc_content["substring"](0, _0x13245["istart"]) +
      _0x178B5 +
      abc_content["substring"](_0x13245["iend"]);
    $("#source")["val"](new_abc_content);
    lastFirstNoteSeq = getFirstNoteSeq();
    src_change();
    doLog();
    return true;
  }
  return false;
}
function handleWeakBar() {
  genInitStaff();
}
function getScoreStr() {
  return "";
  var _0x137A1 = "%%score ";
  var _0x1520B = 0;
  var _0x151A9 = 0;
  $["each"]($(".toneClass"), function (_0x11901, _0x147B5) {
    var _0x1526D = $(_0x147B5)["val"]();
    if (parseInt(_0x1526D) < 7) {
      _0x1520B++;
      _0x137A1 += "{";
    } else {
      if (_0x1520B > 0) {
        _0x1520B--;
        if (_0x1520B > 0) {
          _0x137A1 += "}";
        }
      }
    }
    if (_0x1520B == 1) {
    }
    _0x137A1 += _0x11901 + " ";
  });
  return _0x137A1;
}
function delStaff(_0x1272B) {
  var _0x13DC1 = $(_0x1272B)["attr"]("staffnum");
  $("#staffProp" + _0x13DC1)["remove"]();
  $("#STAFFNUM")["val"](parseInt($("#STAFFNUM")["val"]()) - 1);
  genInitStaff();
}
function addStaff() {
  $("#STAFFNUM")["val"](parseInt($("#STAFFNUM")["val"]()) + 1);
  genInitStaff();
  initStaffProp();
}
function backfilStaffProp(_0x12E0F) {
  $("#STAFFNUM")["val"](_0x12E0F["vocalCount"]);
  if (has_weak_node) {
    $("#nodecount")["val"](_0x12E0F["barCount"] - 1);
  } else {
    $("#nodecount")["val"](_0x12E0F["barCount"]);
  }
  if (_0x12E0F["lineBarNum"] != -1) {
    $("#barsperstaff")["val"](_0x12E0F["lineBarNum"]);
  } else {
    $("#barsperstaff")["val"]("");
  }
  if (_0x12E0F["hasWeakNode"] && _0x12E0F["weakNodeVal"] > 0) {
    $("#isR")["prop"]("checked", true);
    $("#weakBarTop")["removeAttr"]("disabled");
    $("#weakBarTop")["val"](_0x12E0F["weakNode"]["top"]);
    $("#weakBarBot")["removeAttr"]("disabled");
    $("#weakBarBot")["val"](_0x12E0F["weakNode"]["bot"]);
  } else {
    $("#isR")["prop"]("checked", false);
    $("#weakBarTop")["attr"]("disabled", "disabled");
    $("#weakBarBot")["attr"]("disabled", "disabled");
  }
  if (_0x12E0F["lineHeight"] != -1) {
    $(".line_height")["val"](_0x12E0F["lineHeight"]);
  } else {
    $(".line_height")["val"]("");
  }
  if (_0x12E0F["meter"] != null) {
    $("#M_mol")["val"](_0x12E0F["meter"]["top"]);
    $("#M_den")["val"](_0x12E0F["meter"]["bot"]);
  }
  if (_0x12E0F["isFreeMeasure"]) {
    $("#nometer")["prop"]("checked", true);
  } else {
    $("#nometer")["prop"]("checked", false);
  }
  $("#Q_DESC")["val"](_0x12E0F["speedDesc"]);
  if (_0x12E0F["speed"] && _0x12E0F["speed"]["meter"]) {
    var _0x12DAD =
      _0x12E0F["speed"]["meter"]["top"] +
      "/" +
      _0x12E0F["speed"]["meter"]["bot"];
    var _0x12CE9 = [
      "1/1",
      "1/2",
      "1/4",
      "1/8",
      "1/16",
      "1/32",
    ];
    var _0x12D4B = _0x12CE9["indexOf"](_0x12DAD);
    $("#Q_V")["val"](_0x12E0F["speed"]["val"]);
    if (_0x12D4B) {
      selectSpeed(_0x12D4B + 1, _0x12DAD);
    }
  }
  if (_0x12E0F["key"] != null) {
    $("#K")["val"](_0x12E0F["key"]);
    switchJiTaChord(_0x12E0F["key"]);
    swithchJianPu(_0x12E0F["key"]);
  }
  if (_0x12E0F["titleFontSize"] != null) {
    $("#titleFontSize")["val"](_0x12E0F["titleFontSize"]);
  }
  if (_0x12E0F["titleFontColor"] != null) {
    $("#titleColor")["val"](_0x12E0F["titleFontColor"]);
    $("#titleColor")["css"]("background-color", _0x12E0F["titleFontColor"]);
  }
  if (_0x12E0F["lyricFontSize"] != null) {
    $("#lyricFontSize")["val"](_0x12E0F["lyricFontSize"]);
  }
  if (_0x12E0F["lyricFontColor"] != null) {
    $("#lyricColor")["val"](_0x12E0F["lyricFontColor"]);
    $("#lyricColor")["css"]("background-color", _0x12E0F["lyricFontColor"]);
  }
}
function genDotInfo(_0x14133, _0x141F7) {
  var abc_content = $("#source")["val"]();
  var _0x145CB = abc_content["substring"](
    _0x14133["istart"],
    _0x14133["iend"]
  );
  var _0x1400D = new Object();
  var _0x14569 = _0x14133["dur"];
  var _0x143E1 = _0x14133["dur"] * _0x141F7;
  var _0x14259 = _0x143E1 - _0x14569;
  var _0x1462D = /([\/0-9]+)/g;
  var _0x13F49 = _0x145CB["match"](_0x1462D);
  var _0x1406F = _0x145CB;
  if (_0x13F49 != null) {
    var _0x1468F = _0x13F49[0];
    _0x1406F = _0x145CB["replaceAll"](_0x1468F, "");
    if (1 == 2) {
      var _0x142BB = _0x1468F["indexOf"]("/");
      var _0x1431D = /\d/["test"](_0x1468F);
      if (_0x142BB > 0 && !_0x1431D) {
        _0x145CB =
          _0x145CB["substring"](0, _0x142BB) +
          val +
          _0x145CB["substring"](_0x142BB);
      } else {
        if (_0x142BB == -1 && _0x1431D) {
          var _0x1437F = parseInt(_0x1468F);
          var _0x144A5 = 1;
          if (val == "7//") {
            _0x144A5 = 7 / 4;
          } else {
            if (val == "3/") {
              _0x144A5 = 3 / 2;
            }
          }
          var _0x14443 = _0x1437F * _0x144A5;
          _0x14443 = decimalsToFractional(_0x14443) + "";
          _0x14443 = _0x14443["replace"]("/4", "//")
            ["replace"]("/2", "/")
            ["replace"]("/1", "");
          _0x145CB = _0x145CB["replace"](/\d/g, _0x14443);
        }
      }
    }
  }
  _0x1400D["note"] = _0x1406F;
  _0x1406F = _0x1406F + getDurStrByNoteDur(_0x143E1, _0x14133["my_ulen"]);
  var _0x14195 = new Array();
  var _0x146F1 = null;
  var _0x14507 = _0x14133["next"];
  while (_0x14507) {
    if (_0x14507["type"] != 8 && _0x14507["type"] != 10) {
      if (_0x14507["type"] == 0) {
        _0x1400D["del_nodeline"] = 1;
        _0x1400D["dur_nodeline_behind"] = _0x14259;
      }
      _0x14195["push"](abc["clone"](_0x14507, 2));
      _0x14507 = _0x14507["next"];
      if (_0x14507 == null) {
        for (
          var _0x11901 = _0x14133["istart"] + 1,
            _0x119C5 = syms["length"];
          _0x11901 < _0x119C5;
          _0x11901++
        ) {
          var _0x1437F = syms[_0x11901];
          if (_0x1437F) {
            if (
              _0x1437F["v"] == _0x14133["v"] &&
              (_0x1437F["type"] == 8 || _0x1437F["type"] == 10)
            ) {
              _0x14507 = _0x1437F;
              break;
            }
          }
        }
      }
      continue;
    }
    if (
      (_0x14507["type"] == 8 || _0x14507["type"] == 10) &&
      _0x14507["dur"] <= _0x14259
    ) {
      _0x14259 = _0x14259 - _0x14507["dur"];
      if (_0x14259 <= 0) {
        if (_0x14259 == 0) {
          _0x14195["push"](abc["clone"](_0x14507, 2));
        } else {
          if (_0x14259 < 0) {
            _0x146F1 = _0x14507;
            _0x146F1["dur"] = _0x14507["dur"] - _0x14259;
            _0x146F1["dur_orig"] = _0x146F1["dur"];
            _0x146F1["notes"]["forEach"](function (_0x147B5, _0x11901) {
              _0x146F1["notes"][_0x11901]["dur"] =
                _0x146F1["dur"];
            });
            var _0x14753 = abc_content["substring"](
              _0x146F1["istart"],
              _0x146F1["iend"]
            );
            _0x14753 = _0x14753["replace"](_0x1462D, "");
            _0x146F1["restStr"] =
              _0x14753 +
              getDurStrByNoteDur(
                _0x146F1["dur"],
                _0x14133["my_ulen"]
              );
          }
        }
        break;
      }
      _0x14195["push"](abc["clone"](_0x14507, 2));
      _0x14507 = _0x14507["next"];
    } else {
      _0x146F1 = _0x14507;
      _0x146F1["dur_orig"] = _0x146F1["dur"] + 0;
      _0x146F1["dur"] = _0x14507["dur"] - _0x14259;
      _0x146F1["notes"]["forEach"](function (_0x147B5, _0x11901) {
        _0x146F1["notes"][_0x11901]["dur"] = _0x146F1["dur"];
      });
      var _0x14753 = abc_content["substring"](
        _0x146F1["istart"],
        _0x146F1["iend"]
      );
      _0x14753 = _0x14753["replace"](_0x1462D, "");
      _0x146F1["restStr"] =
        _0x14753 +
        getDurStrByNoteDur(_0x146F1["dur"], _0x14133["my_ulen"]);
      break;
    }
  }
  _0x1400D["note_dur"] = _0x143E1;
  _0x1400D["ulen"] = _0x14133["my_ulen"];
  _0x1400D["noteStr"] = _0x1406F;
  _0x1400D["del_s"] = _0x14195;
  _0x1400D["update_dur_s"] = _0x146F1;
  replaceNote(
    "source",
    _0x14133["istart"],
    _0x14133["iend"],
    _0x1400D
  );
  return;
  abc_content =
    abc_content["substring"](0, _0x14133["istart"]) +
    _0x145CB +
    abc_content["substring"](_0x14133["iend"]);
  $("#source")["val"](abc_content);
  if (musicType == 2) {
    src_change();
  } else {
    render();
  }
  doLog();
  return;
}
function setBarBgColor() {
  var _0x1646B = $("#barBgColorInput")["val"]();
  if (_0x1646B["indexOf"]("#") < 0) {
    _0x1646B = "#" + _0x1646B;
  }
  setNodeBgColor(_0x1646B);
}
function switchBarRestShow(_0x151A9) {
  console["log"]("switchBarRestShow");
  var _0x13E85 = $("svg[type='rectnode'],svg[type='rectbar']");
  var abc_content = $("#source")["val"]();
  if (_0x13E85["length"] > 0) {
    var _0x17ED5 = new Array();
    $["each"]($(_0x13E85), function (_0x11901, _0x147B5) {
      var _0x12605 = $(_0x147B5)["attr"]("id");
      var _0x14F5D = _0x12605["replace"]("mysvgnode", "")[
        "replace"
      ]("mysvgbar", "");
      var _0x1778F, _0x15147;
      if (_0x14F5D["indexOf"]("_") > -1) {
        _0x1778F = parseInt(_0x14F5D["split"]("_")[1]);
        _0x15147 = parseInt(_0x14F5D["split"]("_")[0]);
      } else {
        _0x1778F = parseInt(_0x14F5D);
        _0x15147 = -1;
      }
      var _0x1272B = new Object();
      _0x1272B["barNum"] = _0x1778F;
      _0x1272B["v"] = _0x15147;
      _0x17ED5["push"](_0x1272B);
    });
    if (_0x17ED5["length"] > 0) {
      var _0x11A89 = getNodesInfo(abc_content);
      var _0x12B61 =
        /(\|[1-9\.]+)|(\|\[[1-9\.]+)|(:\|\|:)|(:\|:)|(:\|)|(::)|(\|:)|(\|\|)|(\|\])|(\|)/g;
      var node_count = 0;
      var _0x11C11 = "";
      var _0x12AFF = new Map();
      var _0x17F99 = [];
      for (
        var _0x11901 = 0, _0x119C5 = _0x11A89["length"];
        _0x11901 < _0x119C5;
        _0x11901++
      ) {
        var _0x11A27 = _0x11A89[_0x11901];
        var _0x11AEB = _0x11A27["lineStr"];
        var _0x11B4D = "";
        if (_0x11A27["type"] == "note") {
          var _0x125A3 = _0x11A27["nodes"];
          var _0x124DF = -1;
          for (var _0x1241B = 0; _0x1241B < _0x125A3["length"]; _0x1241B++) {
            var _0x17FFB = _0x125A3[_0x1241B];
            var _0x17E73 = abc_content["substring"](
              _0x17FFB["startSeq"],
              _0x17FFB["endSeq"]
            );
            var _0x165F3 = _0x17E73;
            for (
              var _0x11963 = 0;
              _0x11963 < _0x17ED5["length"];
              _0x11963++
            ) {
              var _0x17F37 = _0x17ED5[_0x11963];
              if (
                _0x17F37["barNum"] == _0x17FFB["nodeIndex"] &&
                _0x17F37["v"] == _0x17FFB["v"] &&
                _0x17F99["indexOf"](
                  _0x17F37["barNum"] + "-" + _0x17F37["v"]
                ) < 0
              ) {
                if (_0x151A9 == "hide") {
                  _0x165F3 = _0x17E73["replace"]("z,", "x")[
                    "replace"
                  ]("z", "x");
                } else {
                  if (_0x151A9 == "show") {
                    _0x165F3 = _0x17E73["replace"]("x", "z");
                  }
                }
                _0x17F99["push"](
                  _0x17F37["barNum"] + "-" + _0x17F37["v"]
                );
              }
            }
            _0x11C11 += _0x165F3;
            _0x124DF = _0x17FFB["endSeq"];
          }
          if (_0x124DF < _0x11A27["endSeq"]) {
            _0x11C11 += abc_content["substring"](_0x124DF, _0x11A27["endSeq"]);
          }
        } else {
          _0x11C11 += _0x11A27["lineStr"] + "\x0A";
        }
      }
    }
    $("#source")["val"](_0x11C11);
    src_change();
    doLog();
    return true;
  }
}
function changeSGch() {
  var _0x123B9 = $("#gchText")["val"]();
  var _0x13555 = $("#gchText")["attr"]("ori_val");
  var _0x12FF9 = $(selectGchInfo)["attr"]("istart");
  var _0x13245 = syms[_0x12FF9];
  if (_0x13245) {
    var _0x1342F = _0x13245["a_gch"];
    var _0x13491 = getGchInfo(_0x13245, _0x13555);
    if (_0x13491 != null) {
      var abc_content = $("#source")["val"]();
      var _0x134F3 =
        $("input[name='gchdirect']:checked")["val"]() + $("input[name='gchfonttype']:checked")["val"]();
      var _0x133CD = $("#gchfontsize")["val"]();
      if (_0x133CD != 14) {
        _0x134F3 += "[font-size:" + _0x133CD + "]";
      }
      _0x134F3 += _0x123B9;
      var _0x1336B = "{";
      var _0x12293 = 0;
      if ($("#xoffset")["val"]() != "") {
        _0x1336B += "x:" + $("#xoffset")["val"]();
        _0x12293++;
      }
      if ($("#yoffset")["val"]() != "") {
        if (_0x12293 > 0) {
          _0x1336B += ",";
        }
        _0x1336B += "y:" + $("#yoffset")["val"]();
        _0x12293++;
      }
      _0x1336B += "}";
      if (_0x12293 == 0) {
        _0x1336B = "";
      }
      abc_content =
        abc_content["substring"](0, _0x13491["istart"]) +
        '"' +
        _0x134F3 +
        _0x1336B +
        '"' +
        abc_content["substring"](_0x13491["iend"]);
      $("#source")["val"](abc_content);
      doLog();
      src_change(function () {
        $("text[gch_istart=" + _0x13491["istart"] + "]")
          ["attr"]("selected", "selected")
          ["css"]("color", "#0E518F");
        selectGchInfo = $("text[gch_istart=" + _0x13491["istart"] + "]");
        $("#gchText")["attr"]("ori_val", _0x123B9);
      });
    }
  }
}
function syncText() {
  if (event["keyCode"] == 13) {
    changeSGch();
  }
}
function setSlurDirect(_0x173BB) {
  var _0x16A29 = "";
  if (_0x173BB == "up") {
    _0x16A29 = "'";
  } else {
    if (_0x173BB == "down") {
      _0x16A29 = ",";
    }
  }
  var _0x1741D = $(".selected_path[type='slur']");
  if (_0x1741D["length"] > 0) {
    var _0x12FF9 = $(_0x1741D)["attr"]("istart");
    var _0x13245 = syms[_0x12FF9];
    var abc_content = $("#source")["val"]();
    var _0x13181 = abc_content["substring"](0, _0x12FF9);
    lastIndex = _0x13181["lastIndexOf"]("(") + 1;
    var _0x15641 = abc_content["substr"](lastIndex, 1);
    if (_0x15641 == "," || _0x15641 == "'") {
      abc_content =
        abc_content["substring"](0, lastIndex) +
        _0x16A29 +
        abc_content["substring"](lastIndex + 1);
    } else {
      abc_content =
        abc_content["substring"](0, lastIndex) +
        _0x16A29 +
        abc_content["substring"](lastIndex);
    }
    $("#source")["val"](abc_content);
    doLog();
    src_change();
  }
}
function switchJiTaChord(_0x1805D) {
  $(".left-hide-content[mkey]")["hide"]();
  $(".left-hide-content[mkey='" + _0x1805D + "']")["show"]();
  switchHx(_0x1805D);
}
function swithchJianPu(_0x1805D) {
  var _0x1830B = _0x1805D["replace"]("#", "")["replace"](
    "b",
    ""
  );
  var _0x182A9 = [
    "C,",
    "D,",
    "E,",
    "F,",
    "G,",
    "A,",
    "B,",
    "C",
    "D",
    "E",
    "F",
    "G",
    "A",
    "B",
    "c",
    "d",
    "e",
    "f",
    "g",
    "a",
    "b",
  ];
  var _0x18247 = _0x182A9["indexOf"](_0x1830B);
  if (_0x18247 > 10) {
    _0x18247 = _0x18247 - 7;
  }
  $["each"]($(".spl-input div[type='spl']"), function (_0x11901, _0x147B5) {
    $(_0x147B5)["attr"]("value", _0x182A9[_0x18247++]);
    $(_0x147B5)["html"](_0x11901 + 1);
    $(_0x147B5)["attr"]("level", 0);
  });
}
function jianPuOperatorUp8(_0x15AD9) {
  var _0x15B3B = "";
  if (_0x15AD9 > 0) {
    _0x15B3B += "'";
  } else {
    if (_0x15AD9 < 0) {
      _0x15B3B += ",";
    }
  }
  $["each"]($(".spl-input div[num]"), function (_0x11901, _0x147B5) {
    var _0x123B9 = $(_0x147B5)["attr"]("value") + _0x15B3B;
    var _0x15BFF = parseInt($(_0x147B5)["attr"]("level")) + _0x15AD9;
    if (Math["abs"](_0x15BFF) > 2) {
      return;
    }
    _0x123B9 = _0x123B9["replace"](",'", "")["replace"](
      "',",
      ""
    );
    _0x123B9 = _0x123B9["replace"](
      /([cdefgab]),/,
      function (_0x15C61, _0x15CC3, _0x15D25) {
        console["log"](_0x15C61, _0x15CC3, _0x15D25);
        return _0x15CC3["toUpperCase"]();
      }
    );
    _0x123B9 = _0x123B9["replace"](
      /([CDEFGAB])'/,
      function (_0x15C61, _0x15CC3, _0x15D25) {
        console["log"](_0x15C61, _0x15CC3, _0x15D25);
        return _0x15CC3["toLowerCase"]();
      }
    );
    $(_0x147B5)["attr"]("value", _0x123B9);
    $(_0x147B5)["attr"]("level", _0x15BFF);
    var _0x15B9D = "";
    if (_0x15BFF > 0) {
      _0x15B9D = '<i class="dot-t-' + _0x15BFF + '"></i>';
    } else {
      if (_0x15BFF < 0) {
        _0x15B9D = '<i class="dot-b-' + Math["abs"](_0x15BFF) + '"></i>';
      }
    }
    $(_0x147B5)["find"]("i")["remove"]();
    $(_0x147B5)["append"]($(_0x15B9D));
  });
}
function mergeNote() {
  var _0x15EAD = $(".selected_text")["length"];
  if (_0x15EAD == 2) {
    var _0x15F71 = $(".selected_text")[0];
    var _0x15DE9 = $(".selected_text")[1];
    var _0x15F0F = parseInt($(_0x15F71)["attr"]("istart"));
    var _0x15D87 = parseInt($(_0x15DE9)["attr"]("istart"));
    if (_0x15F0F > _0x15D87) {
      var _0x14F5D = _0x15F0F + 0;
      _0x15F0F = _0x15D87 + 0;
      _0x15D87 = _0x14F5D;
    }
    var abc_content = $("#source")["val"]();
    var _0x15FD3 = syms[_0x15F0F];
    var _0x15E4B = syms[_0x15D87];
    var _0x1311F = abc_content["substring"](
      _0x15FD3["iend"],
      _0x15E4B["istart"]
    );
    _0x1311F = _0x1311F["replace"](/\s/g, "");
    abc_content =
      abc_content["substring"](0, _0x15FD3["iend"]) +
      _0x1311F +
      abc_content["substring"](_0x15E4B["istart"]);
    $("#source")["val"](abc_content);
    doLog();
    src_change();
  } else {
    window["top"]["alert"]("\u8bf7\u9009\u62e92\u4e2a\u97f3\u7b26\u540e\u518d\u8fdb\u884c\u5408\u5e76\u64cd\u4f5c");
  }
}
var lastCoorStrLen = 0;
function setGchPos(_0x1621F) {
  var _0x12FF9 = $("#zsistart")["val"]();
  var _0x13245 = syms[_0x12FF9];
  if (_0x13245) {
    var _0x1342F = _0x13245["a_gch"];
    var _0x123B9 = $("#gchText")["val"]();
    if (_0x123B9 == "") {
      _0x123B9 = $("#zsInput")["val"]();
    }
    var _0x13491 = getGchInfo(_0x13245, _0x123B9);
    if (_0x13491 != null) {
      getGchCoorInfo(_0x13491["text"]);
      lastCoorStrLen = $("#gchcoor")["val"]()["length"];
      var _0x1241B = $("#xoffset")["val"]();
      var _0x1247D = $("#yoffset")["val"]();
      if (_0x1241B == "") {
        _0x1241B = 0;
      }
      if (_0x1247D == "") {
        _0x1247D == 0;
      }
      if (_0x1621F == "left") {
        _0x1241B--;
      } else {
        if (_0x1621F == "right") {
          _0x1241B++;
        } else {
          if (_0x1621F == "up") {
            _0x1247D++;
          } else {
            if (_0x1621F == "down") {
              _0x1247D--;
            }
          }
        }
      }
      $("#xoffset")["val"](_0x1241B);
      $("#yoffset")["val"](_0x1247D);
      var abc_content = $("#source")["val"]();
      var _0x134F3 =
        ($("input[name='gchdirect']:checked")["val"]()
          ? $("input[name='gchdirect']:checked")["val"]()
          : "") + $("input[name='gchfonttype']:checked")["val"]();
      if ($("#ZS_EDIT_div")["css"]("display") == "block") {
        _0x134F3 =
          $("input[name='zspos']:checked")["val"]() + $("input[name='fonttype']:checked")["val"]();
      }
      var _0x133CD = $("#gchfontsize")["val"]();
      if (_0x133CD != 14) {
        _0x134F3 += "[font-size:" + _0x133CD + "]";
      }
      _0x134F3 += _0x123B9;
      var _0x1336B = genGchCoorStr();
      var _0x16A8B = _0x1336B["length"];
      $("#zsistart")["val"](
        parseInt(_0x12FF9) + parseInt(_0x16A8B - lastCoorStrLen)
      );
      _0x134F3 += _0x1336B;
      abc_content =
        abc_content["substring"](0, _0x13491["istart"]) +
        '"' +
        _0x134F3 +
        '"' +
        abc_content["substring"](_0x13491["iend"]);
      $("#source")["val"](abc_content);
      doLog();
      src_change(reselectGch);
    }
  }
}
function reselectGch() {
  var _0x12FF9 = $("#zsistart")["val"]();
  $("text[type='zs'][istart='" + _0x12FF9 + "']")
    ["css"]("color", "#0E518F")
    ["attr"]("selected", "selected");
}
function changeMusicSpace(_0x12F35) {
  var abc_content = $("#source")["val"]();
  if (abc_content["indexOf"]("%%musicspace") > -1) {
    abc_content = abc_content["replace"](/%%musicspace.*/, "%%musicspace " + _0x12F35);
  } else {
    abc_content = "%%musicspace " + _0x12F35 + "\x0A" + abc_content;
  }
  $("#source")["val"](abc_content);
  src_change();
}
function changeTitleSpace(_0x12F35) {
  var abc_content = $("#source")["val"]();
  if (abc_content["indexOf"]("%%titlespace") > -1) {
    abc_content = abc_content["replace"](/%%titlespace.*/, "%%titlespace " + _0x12F35);
  } else {
    abc_content = "%%titlespace " + _0x12F35 + "\x0A" + abc_content;
  }
  $("#source")["val"](abc_content);
  src_change();
}
function changeComposerSpace(_0x12F35) {
  var abc_content = $("#source")["val"]();
  if (abc_content["indexOf"]("%%composerspace") > -1) {
    abc_content = abc_content["replace"](
      /%%composerspace.*/,
      "%%composerspace " + _0x12F35
    );
  } else {
    abc_content = "%%composerspace " + _0x12F35 + "\x0A" + abc_content;
  }
  $("#source")["val"](abc_content);
  src_change();
}
function setDirName() {
  var _0x16A29 = "files/abc/" + new Date()["Format"]("yyyyMMdd");
  $("#dirname")["val"](_0x16A29);
}
function uploadNotePic() {
  setDirName();
  ossUploadType = "noteImg";
  $("#postfiles")["click"]();
}
function uploadNotePicCallback(_0x18C9D) {
  var _0x140D1 = $(".selected_text");
  var _0x12FF9 = $(_0x140D1)["attr"]("istart");
  if (_0x12FF9 && _0x12FF9 != -1) {
    var _0x13245 = syms[_0x12FF9];
    if (_0x13245) {
      lastSelectedNoteIstart = parseInt(_0x12FF9);
      var abc_content = $("#source")["val"]();
      var new_abc_content = "";
      lastSelectedNoteIstart = lastSelectedNoteIstart + _0x18C9D["length"];
      new_abc_content =
        abc_content["substring"](0, _0x13245["istart"]) +
        _0x18C9D +
        abc_content["substring"](_0x13245["istart"]);
      $("#source")["val"](new_abc_content);
      src_change(reSelectNote);
      doLog();
    }
  }
}
function enabledInsertWord(_0x1272B) {
  user["clickAddText"] = false;
  if ($(_0x1272B)["hasClass"]("menu-pressed")) {
    $("#target")["css"]("cursor", "default");
    $(_0x1272B)["removeClass"]("menu-pressed");
    src_change();
  } else {
    if ($("#graphEditorMenuInsert")["hasClass"]("menu-pressed")) {
      switchPrachEditor();
    }
    if ($("#selectedStatus")["hasClass"]("menu-pressed")) {
      enabledEditor($("#selectedStatus")[0]);
    }
    $(_0x1272B)["addClass"]("menu-pressed");
    $("#target")["css"]("cursor", "text");
    user["clickAddText"] = true;
  }
}
function addEditorText(_0x11E5D, _0x11D37, _0x11D99, _0x11DFB, _0x11CD5) {
  var _0x120A9 = $("#target")["offset"]()["top"];
  var _0x12047 = $("#target")["offset"]()["left"];
  var _0x1210B = _0x11E5D["target"];
  if (_0x1210B == null) {
    return;
  }
  if (_0x1210B["tagName"]["toLowerCase"]() != "svg") {
    var _0x11FE5 = $(_0x1210B)["parents"]("svg");
    _0x1210B = _0x11FE5[_0x11FE5["length"] - 1];
  } else {
    _0x1210B = $(_0x1210B);
    if (_0x1210B["length"] > 1) {
      return;
    }
  }
  var _0x11EBF = document["createElement"]("div");
  $(_0x11EBF)
    ["css"]("z-index", 99999)
    ["css"]("position", "absolute")
    ["css"]("background-color", "white");
  $(_0x11EBF)["attr"]("contenteditable", "true");
  $(_0x11EBF)["addClass"]("editor-div");
  $(_0x11EBF)["attr"]("type", "mytext");
  if (_0x11D37) {
    $(_0x11EBF)["text"](_0x11D37);
  }
  var _0x11F21 = false;
  var _0x11F83 = false;
  $(_0x11EBF)["focus"](function (_0x1216D) {
    console["log"]("\u805a\u7126");
    _0x11F21 = true;
  });
  $(_0x11EBF)["blur"](function (_0x1216D) {
    console["log"]("\u5931\u7126", _0x1216D);
    _0x11F21 = false;
    var _0x121CF = this;
    setTimeout(function () {
      if (_0x11F21) {
        return;
      }
      var _0x123B9 = $(_0x121CF)["html"]();
      var _0x122F5 = null;
      var _0x12357 = /\<div(([\s\S])*?)\<\/div\>/g;
      var _0x12231 = [];
      var _0x12293 = 0;
      while ((_0x122F5 = _0x12357["exec"](_0x123B9))) {
        if (_0x12293 == 0) {
          if (_0x122F5["index"] != 0) {
            _0x12231["push"](
              _0x123B9["substring"](0, _0x122F5["index"])
            );
          }
        }
        _0x12231["push"](
          _0x122F5[1]
            ["replaceAll"]("<br>", "")
            ["replace"](">", "")
            ["replace"](/\s/g, "")
        );
        _0x12293++;
      }
      if (_0x12293 == 0) {
        _0x12231["push"](
          _0x123B9["replace"](/\s/g, "")["replaceAll"](
            "<br>",
            ""
          )
        );
      }
      while (_0x12231[_0x12231["length"] - 1] == "") {
        _0x12231["splice"](_0x12231["length"] - 1, 1);
      }
      console["log"](_0x12231);
      $(_0x121CF)["remove"]();
      if (_0x11CD5) {
        updateMyTextInfo(null, null, _0x11CD5, _0x123B9);
      } else {
        if (_0x123B9 != "") {
          var _0x1241B = parseInt(
            parseInt(
              $(_0x11EBF)
                ["css"]("left")
                ["replace"]("px", "")
            ) / scale
          );
          var _0x1247D = parseInt(
            (parseInt(
              $(_0x11EBF)
                ["css"]("top")
                ["replace"]("px", "")
            ) -
              ($(_0x1210B)["offset"]()["top"] -
                $(".right-top-content")["offset"]()["top"] +
                $(".right-top-content")["scrollTop"]()) +
              15) /
              scale
          );
          console["log"]("e.x", _0x1241B, _0x1247D);
          if (_0x11CD5) {
            updateMyTextInfo(_0x1241B, _0x1247D, _0x11CD5);
          } else {
            addText2SvgAndSource(
              _0x1241B,
              _0x1247D,
              _0x1210B,
              _0x123B9,
              new Date()["getTime"]()
            );
          }
        }
      }
    }, 50);
  });
  $(_0x11EBF)["css"]({
    left: _0x11D99 ? _0x11D99 : _0x11E5D["offsetX"] + 1,
    top: _0x11DFB ? _0x11DFB : _0x11E5D["y"] - _0x120A9,
    "min-width": 40,
    "min-height": 30,
  });
  $("#target")["append"]($(_0x11EBF));
  $(_0x11EBF)["focus"]();
  showProperties("text", _0x11E5D);
}
var dragMyText = false;
var hasDragMyText = false;
var myTextMouseDownTime = 0;
function addText2Svg(_0x1241B, _0x1247D, _0x1210B, _0x1278D, _0x12605) {
  var abc_content = $("#source")["val"]();
  var _0x1272B = new Object();
  _0x1272B["text"] = _0x1278D;
  _0x1272B["fontsize"] = 14;
  _0x1272B["svgIndex"] = $(_0x1210B)["attr"]("index");
  var _0x126C9 = "http://www.w3.org/2000/svg";
  var _0x12667 = document["createElementNS"](_0x126C9, "text");
  _0x12667["setAttribute"]("id", _0x12605);
  _0x1272B["id"] = _0x12605;
  _0x12667["setAttribute"]("x", _0x1241B);
  _0x12667["setAttribute"]("type", "mytext");
  _0x1272B["x"] = _0x1241B;
  _0x12667["setAttribute"]("y", _0x1247D + 15);
  _0x1272B["y"] = _0x1247D;
  $(_0x12667)["css"]("font-size", "14px");
  _0x12667["addEventListener"]("mousedown", function (_0x1216D) {
    if (user["mode"] == "editor") {
      myTextMouseDownTime = new Date()["getTime"]();
      dragMyText = true;
      $("text[type='mytext']")["removeClass"]("selected_text");
      $(this)["addClass"]("selected_text");
      _0x1216D["preventDefault"]();
      _0x1216D["stopPropagation"]();
      return false;
    }
  });
  _0x12667["addEventListener"]("mousemove", function (_0x1216D) {
    if (user["mode"] == "editor") {
      if (dragMyText) {
        var _0x128B3 = $(_0x1216D["target"])["parents"]("g")[0];
        var _0x12915 = $(_0x128B3)["attr"]("transform");
        var _0x12851 = getTransformsTranslate(_0x12915);
        if (_0x12851 == null) {
          _0x12851 = new Object();
          _0x12851["x"] = 0;
          _0x12851["y"] = 0;
        }
        $(event["target"])["attr"](
          "x",
          _0x1216D["offsetX"] / scale -
            $(_0x1216D["target"])[0]["getBBox"]()["width"] / 2
        );
        $(event["target"])["attr"](
          "y",
          _0x1216D["offsetY"] / scale - _0x12851["y"] + 5
        );
      }
      _0x1216D["preventDefault"]();
      _0x1216D["stopPropagation"]();
      return false;
    }
  });
  _0x12667["addEventListener"]("mouseup", function (_0x1216D) {
    if (user["mode"] == "editor") {
      var _0x12977 = new Date()["getTime"]();
      if (_0x12977 - myTextMouseDownTime < 200) {
        return;
      }
      dragMyText = false;
      var _0x11FE5 = $(this)["parents"]("svg");
      var _0x1210B = _0x11FE5[_0x11FE5["length"] - 1];
      var _0x1241B = parseInt(parseInt($(this)["attr"]("x")));
      var _0x1247D = parseInt(
        parseInt($(this)["attr"]("y")) - 15
      );
      console["log"]("e.x", _0x1241B, _0x1247D);
      updateMyTextInfo(_0x1241B, _0x1247D, $(this)["attr"]("id"));
      _0x1216D["preventDefault"]();
      _0x1216D["stopPropagation"]();
      return false;
    }
  });
  _0x12667["addEventListener"]("dblclick", function (_0x1216D) {
    addEditorText(
      _0x1216D,
      $(_0x12667)["text"](),
      parseInt($(_0x12667)["attr"]("x")) * scale,
      parseInt($(_0x12667)["attr"]("y")) * scale - 15,
      $(_0x12667)["attr"]("id")
    );
  });
  var _0x127EF = document["createTextNode"](_0x1278D);
  _0x12667["appendChild"](_0x127EF);
  $(_0x1210B)["children"]("g")["append"](_0x12667);
  return _0x1272B;
}
function delMyTextInfo(_0x12605) {
  var abc_content = $("#source")["val"]();
  var _0x12357 = new RegExp('.*"id":' + _0x12605 + ".*");
  var _0x11BAF = _0x12357["exec"](abc_content);
  if (_0x11BAF != null) {
    console["log"](_0x11BAF[0]);
    var _0x137A1 = _0x11BAF[0];
    abc_content = abc_content["replace"](_0x137A1, "");
    abc_content = replaceBlankLine(abc_content);
    $("#source")["val"](abc_content);
    doLog();
    src_change();
  }
}
function updateMyTextInfo(_0x1241B, _0x1247D, _0x12605, _0x123B9) {
  var abc_content = $("#source")["val"]();
  var _0x12357 = new RegExp('.*"id":' + _0x12605 + ".*");
  var _0x11BAF = _0x12357["exec"](abc_content);
  if (_0x11BAF != null) {
    console["log"](_0x11BAF[0]);
    var _0x137A1 = _0x11BAF[0];
    var _0x1272B = JSON["parse"](_0x137A1);
    if (_0x1241B) {
      _0x1272B["x"] = _0x1241B;
    }
    if (_0x1247D) {
      _0x1272B["y"] = _0x1247D;
    }
    if (_0x123B9) {
      _0x1272B["text"] = _0x123B9;
    }
    var _0x178B5 = JSON["stringify"](_0x1272B);
    abc_content = abc_content["replace"](_0x137A1, _0x178B5);
    abc_content = replaceBlankLine(abc_content);
    $("#source")["val"](abc_content);
    doLog();
    src_change();
  }
}
function addText2SvgAndSource(
  _0x1241B,
  _0x1247D,
  _0x1210B,
  _0x1278D,
  _0x12605
) {
  var _0x129D9 = addText2Svg(_0x1241B, _0x1247D, _0x1210B, _0x1278D, _0x12605);
  setMyText(JSON["stringify"](_0x129D9));
}
function setMyText(_0x137A1) {
  var abc_content = $("#source")["val"]();
  var _0x12357 = /%%beginmytext([\n\r\s\S]*)%%endmytext/;
  var _0x13F49 = abc_content["match"](_0x12357);
  var _0x16FE7 = "%%beginmytext";
  if (_0x13F49 != null) {
    _0x16FE7 += _0x13F49[1] + _0x137A1;
    _0x16FE7 += "\x0A%%endmytext";
    abc_content = abc_content["replace"](_0x13F49[0], _0x16FE7);
  } else {
    _0x16FE7 += "\x0A" + _0x137A1;
    _0x16FE7 += "\x0A%%endmytext\x0A";
    abc_content = _0x16FE7 + abc_content;
  }
  $("#source")["val"](abc_content);
}
function changeSlyric() {
  var abc_content = $("#source")["val"]();
  var _0x1278D = $("#lyricText")["val"]();
  var _0x13803 = $("#lyricTextUp")["val"]();
  var _0x1367B = $("#lyricTextDown")["val"]();
  var _0x13619 = $("#lyricBgColor")["val"]();
  var _0x135B7 = $("input[name='lyricAlign']:checked")["val"]();
  var _0x137A1 = "";
  if (_0x135B7 == "right") {
    _0x137A1 += "[R]";
  }
  _0x137A1 += _0x1278D;
  if (_0x1367B != "") {
    _0x137A1 += "[_" + _0x1367B + "]";
  }
  if (_0x13803 != "") {
    _0x137A1 += "[^" + _0x13803 + "]";
  }
  var _0x1373F = $("#editorLyricIstart")["val"]();
  var _0x136DD = $("#editorLyricIend")["val"]();
  abc_content =
    abc_content["substring"](0, _0x1373F) +
    _0x13619 +
    _0x137A1 +
    abc_content["substring"](_0x136DD);
  $("#source")["val"](abc_content);
  doLog();
  src_change(function () {
    var _0x13245 = syms[_0x1373F];
    $("text[type='lyric'][lyric_istart='" + _0x1373F + "']")["css"](
      "color",
      "#0E518F"
    );
    $("#editorLyricIend")["val"](_0x13245["iend"]);
  });
}
function switchLyricAlign(_0x135B7) {
  var _0x180BF = "";
  if (_0x135B7 == "right") {
    _0x180BF = "[R]";
  } else {
    if (_0x135B7 == "left") {
      _0x180BF = "[L]";
    }
  }
  var abc_content = $("#source")["val"]();
  var _0x1373F = $("#editorLyricIstart")["val"]();
  var _0x136DD = $("#editorLyricIend")["val"]();
  var _0x16CD7 = abc_content["substring"](_0x1373F, _0x136DD);
  _0x16CD7 = _0x16CD7["replace"]("[R]", "")["replace"](
    "[L]",
    ""
  );
  abc_content =
    abc_content["substring"](0, _0x1373F) +
    _0x180BF +
    _0x16CD7 +
    abc_content["substring"](_0x136DD);
  $("#source")["val"](abc_content);
  doLog();
  src_change(function () {
    var _0x13245 = syms[_0x1373F];
    $("text[type='lyric'][lyric_istart='" + _0x1373F + "']")["css"](
      "color",
      "#0E518F"
    );
    $("#editorLyricIend")["val"](_0x13245["iend"]);
  });
}
function setLyricBgColor() {
  var _0x1646B = $("#lyricBgColorInput")["val"]();
  if (_0x1646B["indexOf"]("#") < 0) {
    _0x1646B = "#" + _0x1646B;
  }
  _0x1646B = colorRGB(_0x1646B);
  var _0x14C4D = lyricBgArray["length"];
  var _0x13B13 = $("text[type='lyric'][selected='selected'],text[type='lyric'].selected_text");
  var abc_content = $("#source")["val"]();
  var _0x13BD7 = 0;
  var _0x1398B = 0;
  var _0x13B75 = 0;
  var _0x12357 = /\[[se]\.lb\.[^\]]*\]/;
  var _0x16AED = /\[[se]\.lb\.([0-9]{1,})\..*\]/;
  if (lyricBgArray["length"] > 0) {
    for (var _0x11901 = 0; _0x11901 < lyricBgArray["length"]; _0x11901++) {
      var _0x16C75 = lyricBgArray[_0x11901];
      var _0x16D39 = parseInt(_0x16C75["seq"]);
      if (_0x16D39 >= _0x14C4D) {
        _0x14C4D = _0x16D39 + 1;
      }
    }
  }
  if (_0x13B13["length"] == 1) {
    _0x13BD7 = $(_0x13B13)["attr"]("lyric_istart");
    var _0x137A1 =
      "[s.lb." + _0x14C4D + "." + _0x1646B + "]";
    _0x13B75 = _0x137A1["length"];
    var _0x13245 = syms[_0x13BD7];
    var _0x16CD7 = abc_content["substring"](
      _0x13245["istart"],
      _0x13245["iend"]
    );
    if (_0x16CD7["indexOf"]("[s.lb.") == 0) {
    }
    var _0x16EC1 = abc_content["substring"](_0x13BD7);
    if (_0x12357["test"](_0x16CD7)) {
      _0x16EC1 = _0x16EC1["replace"](_0x12357, "");
      _0x13B75 -= _0x12357["exec"](_0x16CD7)[0]["length"];
      var _0x13AB1 = _0x16AED["exec"](_0x16CD7)[1];
      _0x137A1 =
        "[s.lb." + _0x13AB1 + "." + _0x1646B + "]";
    }
    abc_content = abc_content["substring"](0, _0x13BD7) + _0x137A1 + _0x16EC1;
  } else {
    if (_0x13B13["length"] == 2) {
      var _0x16E5F =
        "[s.lb." + _0x14C4D + "." + _0x1646B + "]";
      var _0x16B4F =
        "[e.lb." + _0x14C4D + "." + _0x1646B + "]";
      _0x13BD7 = parseInt($(_0x13B13[0])["attr"]("lyric_istart"));
      _0x1398B = parseInt($(_0x13B13[1])["attr"]("lyric_istart"));
      if (_0x13BD7 > _0x1398B) {
        var _0x16F23 = _0x13BD7 - 0;
        _0x13BD7 = _0x1398B - 0;
        _0x1398B = _0x16F23;
      }
      _0x13B75 += _0x16E5F["length"];
      var _0x16DFD = syms[_0x13BD7];
      var _0x16C13 = syms[_0x1398B];
      var _0x16D9B = abc_content["substring"](
        _0x16DFD["istart"],
        _0x16DFD["iend"]
      );
      var _0x16BB1 = abc_content["substring"](
        _0x16C13["istart"],
        _0x16C13["iend"]
      );
      var _0x1311F = abc_content["substring"](_0x13BD7, _0x1398B);
      var _0x16EC1 = abc_content["substring"](_0x1398B);
      if (_0x12357["test"](_0x16D9B)) {
        _0x1311F = _0x1311F["replace"](_0x12357, "");
        _0x13B75 -= _0x12357["exec"](_0x16D9B)[0]["length"];
        var _0x13AB1 = _0x16AED["exec"](_0x16D9B)[1];
        _0x16E5F =
          "[s.lb." + _0x13AB1 + "." + _0x1646B + "]";
      }
      if (_0x12357["test"](_0x16BB1)) {
        _0x16EC1 = _0x16EC1["replace"](_0x12357, "");
        var _0x13AB1 = _0x16AED["exec"](_0x16BB1)[1];
        _0x16B4F =
          "[e.lb." + _0x13AB1 + "." + _0x1646B + "]";
      }
      abc_content =
        abc_content["substring"](0, _0x13BD7) +
        _0x16E5F +
        _0x1311F +
        _0x16B4F +
        _0x16EC1;
    }
  }
  $("#source")["val"](abc_content);
  doLog();
  src_change(function () {
    $("text[type='lyric'][lyric_istart='" + _0x13BD7 + "']")
      ["css"]("color", "#0E518F")
      ["attr"]("selected", "selected");
    if (_0x1398B != 0) {
      _0x1398B = _0x1398B + _0x13B75;
      $("text[type='lyric'][lyric_istart='" + _0x1398B + "']")
        ["css"]("color", "#0E518F")
        ["attr"]("selected", "selected");
    }
  });
}
function clearLyricBgColor() {
  var abc_content = $("#source")["val"]();
  var _0x13BD7 = 0;
  var _0x1398B = 0;
  var _0x13B75 = 0;
  var _0x13B13 = $("text[type='lyric'][selected='selected']");
  var _0x12357 = /\[[se]\.lb\.([0-9]{1,})\..[^\[]*\]/;
  if (_0x13B13["length"] > 0) {
    _0x13BD7 = $(_0x13B13)["attr"]("lyric_istart");
    var _0x13245 = syms[_0x13BD7];
    var _0x139ED = abc_content["substring"](
      _0x13245["istart"],
      _0x13245["iend"]
    );
    if (_0x12357["test"](_0x139ED)) {
      var _0x13AB1 = _0x12357["exec"](_0x139ED)[1];
      var _0x13A4F = new RegExp(
        "\\[[se]\\.lb\\." + _0x13AB1 + "\\..[^\\[]*\\]",
        "g"
      );
      abc_content = abc_content["replace"](_0x13A4F, "");
    }
  }
  $("#source")["val"](abc_content);
  doLog();
  src_change(function () {
    $("text[type='lyric'][lyric_istart='" + _0x13BD7 + "']")
      ["css"]("color", "#0E518F")
      ["attr"]("selected", "selected");
    if (_0x1398B != 0) {
      _0x1398B = _0x1398B + _0x13B75;
      $("text[type='lyric'][lyric_istart='" + _0x1398B + "']")
        ["css"]("color", "#0E518F")
        ["attr"]("selected", "selected");
    }
  });
}
function setSingleLyricColor() {
  var _0x1646B = $("#singleLyricColorInput")["val"]();
  if (_0x1646B["indexOf"]("#") < 0) {
    _0x1646B = "#" + _0x1646B;
  }
  _0x1646B = colorRGB(_0x1646B);
  var _0x13B13 = $("text[type='lyric'][selected='selected'],text[type='lyric'].selected_text");
  var abc_content = $("#source")["val"]();
  if (_0x13B13["length"] > 0) {
    var new_abc_content = "";
    var _0x1305B = 0;
    for (var _0x11901 = 0; _0x11901 < _0x13B13["length"]; _0x11901++) {
      var _0x13BD7 = $(_0x13B13[_0x11901])["attr"]("lyric_istart");
      var _0x13245 = syms[_0x13BD7];
      if (_0x13245) {
        var _0x139ED = abc_content["substring"](
          _0x13245["istart"],
          _0x13245["iend"]
        );
        if (lyricColorReg["test"](_0x139ED)) {
          _0x139ED = _0x139ED["replace"](lyricColorReg, "");
        }
        _0x139ED = "[" + _0x1646B + "]" + _0x139ED;
        new_abc_content +=
          abc_content["substring"](_0x1305B, _0x13245["istart"]) + _0x139ED;
        _0x1305B = _0x13245["iend"];
      }
    }
    if (new_abc_content != "") {
      new_abc_content += abc_content["substring"](_0x1305B);
      $("#source")["val"](new_abc_content);
      doLog();
      src_change(function () {
        for (var _0x11901 = 0; _0x11901 < _0x13B13["length"]; _0x11901++) {
          var _0x13BD7 = $(_0x13B13[_0x11901])["attr"]("lyric_istart");
          $("text[type='lyric'][lyric_istart='" + _0x13BD7 + "']")
            ["css"]("color", _0x1646B)
            ["attr"]("selected", "selected");
        }
      });
    }
  }
}
function clearSingleLyricColor() {
  var abc_content = $("#source")["val"]();
  var _0x13B13 = $("text[type='lyric'][selected='selected']");
  var _0x12357 = /\[[se]\.lb\.([0-9]{1,})\..[^\[]*\]/;
  if (_0x13B13["length"] > 0) {
    var new_abc_content = "";
    var _0x1305B = 0;
    for (var _0x11901 = 0; _0x11901 < _0x13B13["length"]; _0x11901++) {
      var _0x13BD7 = $(_0x13B13[_0x11901])["attr"]("lyric_istart");
      var _0x13245 = syms[_0x13BD7];
      if (_0x13245) {
        var _0x139ED = abc_content["substring"](
          _0x13245["istart"],
          _0x13245["iend"]
        );
        if (lyricColorReg["test"](_0x139ED)) {
          _0x139ED = _0x139ED["replace"](lyricColorReg, "");
        }
        new_abc_content +=
          abc_content["substring"](_0x1305B, _0x13245["istart"]) + _0x139ED;
        _0x1305B = _0x13245["iend"];
      }
    }
    if (new_abc_content != "") {
      new_abc_content += abc_content["substring"](_0x1305B);
      $("#source")["val"](new_abc_content);
      doLog();
      src_change(function () {});
    }
  }
}
function delVoice() {
  var _0x13E85 = $("svg[type='rectbar'],svg[type='rectnode']");
  var abc_content = $("#source")["val"]();
  if (_0x13E85["length"] > 0) {
    var _0x12605 = $(_0x13E85[0])["attr"]("id");
    var _0x13E23 = _0x12605["replace"]("mysvgbar", "")[
      "replace"
    ]("mysvgnode", "");
    var _0x13EE7 = parseInt(_0x13E23["split"]("_")[0]);
    var _0x11A89 = getLinesInfo(abc_content);
    var new_abc_content = "";
    for (var _0x11901 = 0; _0x11901 < _0x11A89["length"]; _0x11901++) {
      var _0x11A27 = _0x11A89[_0x11901];
      var _0x11AEB = _0x11A27["lineStr"];
      if (_0x11A27["v"] == _0x13EE7) {
        continue;
      } else {
        if (
          _0x11A27["type"] == "v" &&
          _0x11A27["vNum"] == _0x13EE7
        ) {
          continue;
        } else {
          if (_0x11A27["type"] == "score") {
            var _0x12357 = new RegExp(parseInt(_0x13EE7) + 1 + ".[^\\d]*");
            _0x11AEB = _0x11AEB["replace"](_0x12357, "");
          }
        }
      }
      new_abc_content += _0x11AEB + "\x0A";
    }
    $("#source")["val"](new_abc_content);
    doLog();
    src_change();
  }
}
function changeNodeLineType(_0x1272B) {
  var _0x12FF9 = $("rect[selected='selected']")["attr"]("istart");
  var _0x13245 = syms[_0x12FF9];
  if (_0x13245) {
    var abc_content = $("#source")["val"]();
    if (_0x13245["bar_dotted"]) {
      abc_content =
        abc_content["substring"](0, _0x13245["istart"] - 1) +
        $(_0x1272B)["val"]() +
        abc_content["substring"](_0x13245["iend"]);
    } else {
      abc_content =
        abc_content["substring"](0, _0x13245["istart"]) +
        $(_0x1272B)["val"]() +
        abc_content["substring"](_0x13245["iend"]);
    }
    $("#source")["val"](abc_content);
    doLog();
    src_change();
  }
}
function changeStaffMargin(_0x138C7, _0x13929) {
  var abc_content = $("#source")["val"]();
  if (_0x138C7 != "") {
    if (abc_content["indexOf"]("%%leftmargin") > -1) {
      abc_content = abc_content["replace"](
        /%%leftmargin.*/,
        "%%leftmargin " + _0x138C7
      );
    } else {
      abc_content = "%%leftmargin " + _0x138C7 + "\x0A" + abc_content;
    }
  }
  if (_0x13929 != "") {
    if (abc_content["indexOf"]("%%rightmargin") > -1) {
      abc_content = abc_content["replace"](
        /%%rightmargin.*/,
        "%%rightmargin " + _0x13929
      );
    } else {
      abc_content = "%%rightmargin " + _0x13929 + "\x0A" + abc_content;
    }
  }
  $("#source")["val"](abc_content);
  doLog();
  src_change();
}
function changeStaffBotMargin(_0x13865) {
  var abc_content = $("#source")["val"]();
  if (_0x13865 != "") {
    if (abc_content["indexOf"]("%%botmargin") > -1) {
      abc_content = abc_content["replace"](
        /%%botmargin.*/,
        "%%botmargin " + _0x13865
      );
    } else {
      abc_content = "%%botmargin " + _0x13865 + "\x0A" + abc_content;
    }
  }
  $("#source")["val"](abc_content);
  doLog();
  src_change();
}
function addLineBreak(abc_content) {
  if (abc_content["indexOf"]("%%linebreak") > -1) {
    return abc_content;
  }
  var _0x11A89 = getNodesInfo(abc_content);
  var _0x11C11 = "";
  for (var _0x11901 = 0; _0x11901 < _0x11A89["length"]; _0x11901++) {
    var _0x12541 = _0x11A89[_0x11901];
    var _0x11AEB = _0x12541["lineStr"];
    if (_0x12541["type"] == "note") {
      var _0x125A3 = _0x12541["nodes"];
      var _0x11B4D = "";
      var _0x124DF = -1;
      for (var _0x11963 = 0; _0x11963 < _0x125A3["length"]; _0x11963++) {
        var _0x11BAF = _0x125A3[_0x11963];
        _0x11B4D += _0x11BAF["nodeStr"];
        _0x124DF = _0x11BAF["endSeq"];
      }
      _0x11C11 +=
        _0x11B4D +
        "$" +
        abc_content["substring"](_0x124DF, _0x12541["endSeq"]);
    } else {
      _0x11C11 += _0x12541["lineStr"] + "\x0A";
    }
  }
  _0x11C11 = "%%linebreak $\x0A" + _0x11C11;
  _0x11C11 = replaceBlankLine(_0x11C11);
  return _0x11C11;
}
function switchSplNoteCenter(_0x135B7) {
  var _0x117DB = $("#nodeMenu")["attr"]("barIndex");
  if (!_0x117DB) {
    return;
  }
  _0x117DB = parseInt(_0x117DB);
  var abc_content = $("#source")["val"]();
  abc_content = abc_content["replace"](/%%barsperstaff.*\n/, "");
  var _0x11A89 = getNodesInfo(abc_content);
  var _0x11C11 = "";
  for (
    var _0x11901 = 0, _0x119C5 = _0x11A89["length"];
    _0x11901 < _0x119C5;
    _0x11901++
  ) {
    var _0x11A27 = _0x11A89[_0x11901];
    var _0x11AEB = _0x11A27["lineStr"];
    var _0x11B4D = "";
    if (_0x11A27["type"] == "note") {
      for (
        var _0x11963 = 0;
        _0x11963 < _0x11A27["nodes"]["length"];
        _0x11963++
      ) {
        var _0x11BAF = _0x11A27["nodes"][_0x11963];
        if (_0x11BAF["nodeIndex"] == _0x117DB) {
          _0x11B4D +=
            "[I:pos spl " +
            _0x135B7 +
            "]" +
            _0x11BAF["nodeStr"]
              ["replace"]("[I:pos spl auto]", "")
              ["replace"]("[I:pos spl center]", "");
        } else {
          _0x11B4D += _0x11BAF["nodeStr"];
        }
        lastNodeEndSeq = _0x11BAF["endSeq"];
      }
      _0x11B4D += abc_content["substring"](lastNodeEndSeq, _0x11A27["endSeq"]);
      _0x11C11 += _0x11B4D + "\x0A";
    } else {
      _0x11C11 += _0x11A27["lineStr"] + "\x0A";
    }
  }
  _0x11C11 = replaceBlankLine(_0x11C11);
  $("#source")["val"](_0x11C11);
  doLog();
  src_change();
}
function splitVoice() {
  var _0x117DB = $("#nodeMenu")["attr"]("barIndex");
  if (!_0x117DB) {
    return;
  }
  _0x117DB = parseInt(_0x117DB);
  var abc_content = $("#source")["val"]();
  abc_content = abc_content["replace"](/%%barsperstaff.*\n/, "");
  var _0x11A89 = getNodesInfo(abc_content);
  var _0x11C11 = "";
  var _0x11C73 = getSelectedBarInfo(_0x117DB, 0);
  console["log"](_0x11C73);
  var _0x17E73 = _0x11C73["nodeStr"];
  if (_0x17E73["indexOf"]("(&") > -1) {
  }
}
function showInstruSelector(_0x17C27) {
  setTimeout(function () {
    $(".menu-pulldown-box")["show"]();
  }, 100);
  _0x17C27["preventDefault"]();
  return false;
}
function setVoiceInstrument(_0x15147, _0x1526D) {
  var abc_content = $("#source")["val"]();
  var _0x176CB = new RegExp("V:s*" + _0x15147 + ".*\x0A%%MIDI program(.*)");
  var _0x17A9F = new RegExp("V:s*" + _0x15147 + ".*\x0A%%MIDI program");
  var _0x11BAF = _0x176CB["exec"](abc_content);
  var _0x17917 = _0x17A9F["exec"](abc_content);
  if (_0x11BAF) {
    var _0x13FAB = _0x11BAF[0];
    var _0x179DB = _0x11BAF[1]["replace"](/\s/g, "");
    var _0x17853 = _0x17917[0] + " " + _0x1526D;
    abc_content = abc_content["replace"](_0x13FAB, _0x17853);
    $("#source")["val"](abc_content);
    doLog();
    src_change();
  } else {
    var _0x17B01 = new RegExp("V:s*" + _0x15147 + ".*");
    var _0x17979 = _0x17B01["exec"](abc_content);
    if (_0x17979) {
      var _0x17A3D = _0x17979[0];
      var _0x178B5 = _0x17A3D + "\x0A%%MIDI program " + _0x1526D;
      abc_content = abc_content["replace"](_0x17A3D, _0x178B5);
      $("#source")["val"](abc_content);
      doLog();
      src_change();
    }
  }
}
function splitNode(_0x17C27) {
  var _0x177F1 = $("svg[type='rectnode']");
  if (_0x177F1["length"] > 0) {
    var _0x17DAF = "z";
    var _0x17CEB = null;
    for (var _0x12FF9 in syms) {
      var _0x13245 = syms[_0x12FF9];
      if (_0x13245["type"] == 8 || _0x13245["type"] == 10) {
        var _0x17D4D = _0x13245["my_wmeasure"] / _0x13245["my_ulen"];
        _0x17DAF += _0x17D4D;
        break;
      }
    }
    var _0x12605 = $(_0x177F1)["attr"]("id");
    var _0x14F5D = _0x12605["replace"]("mysvgnode", "")[
      "replace"
    ]("mysvgbar", "");
    var _0x1778F, _0x15147;
    if (_0x14F5D["indexOf"]("_") > -1) {
      _0x1778F = parseInt(_0x14F5D["split"]("_")[1]);
      _0x15147 = parseInt(_0x14F5D["split"]("_")[0]);
    } else {
      _0x1778F = parseInt(_0x14F5D);
      _0x15147 = -1;
    }
    var _0x11C73 = getSelectedBarInfo(_0x1778F, _0x15147);
    console["log"](_0x11C73);
    var _0x17E11 = _0x11C73["nodeStr"]["replace"](
      _0x11C73["barLineStr"],
      ""
    );
    var new_abc_content =
      "(&" +
      _0x17E11 +
      " & " +
      _0x17DAF +
      "&)" +
      _0x11C73["barLineStr"];
    var abc_content = $("#source")["val"]();
    abc_content =
      abc_content["substring"](0, _0x11C73["startSeq"]) +
      new_abc_content +
      abc_content["substring"](_0x11C73["endSeq"]);
    $("#source")["val"](abc_content);
    doLog();
    src_change();
  }
}
function changeFermatatime(_0x123B9) {
  var _0x132A7 = $("text[type='hld'][selected='selected'],text.selected_text[type='hld']");
  if (_0x132A7["length"] > 0) {
    var _0x12FF9 = $(_0x132A7)["attr"]("istart");
    var abc_content = $("#source")["val"]();
    var _0x13245 = syms[_0x12FF9];
    var _0x131E3 = _0x13245["prev"];
    var _0x13181 = abc_content["substring"](0, _0x13245["istart"]);
    var _0x13309 = abc_content["substring"](_0x13245["istart"]);
    var _0x1278D = getGch(_0x13245, "fermata");
    if (_0x13245["fermatatime"]) {
      var _0x12357 = /\"fermatatime:[^\"]*\"/g;
      var _0x11BAF;
      var _0x1305B = -1;
      var _0x130BD = "";
      while ((_0x11BAF = _0x12357["exec"](_0x13181))) {
        _0x1305B = _0x11BAF["index"];
        _0x130BD = _0x11BAF[0];
      }
      var _0x12F97 = '"fermatatime:' + _0x123B9 + '"';
      abc_content =
        abc_content["substring"](0, _0x1305B) +
        abc_content["substring"](_0x1305B)["replace"](_0x130BD, _0x12F97);
      _0x13245["istart"] += _0x12F97["length"] - _0x130BD["length"];
    } else {
      var _0x1311F = '"fermatatime:' + _0x123B9 + '"';
      abc_content =
        abc_content["substring"](0, _0x13245["istart"]) +
        _0x1311F +
        abc_content["substring"](_0x13245["istart"]);
      _0x13245["istart"] += _0x1311F["length"];
    }
    _0x13245["fermatatime"] = _0x123B9;
    $("#source")["val"](abc_content);
    doLog();
    src_change(function () {
      $("text[type='hld'][istart='" + _0x13245["istart"] + "']")
        ["attr"]("selected", "selected")
        ["addClass"]("selected_text");
    });
  }
}
function setStaffNameHandle() {
  var _0x177F1 = $("svg[type='rectnode']");
  if (_0x177F1["length"] > 0) {
    var _0x12605 = $(_0x177F1)["attr"]("id");
    var _0x14F5D = _0x12605["replace"]("mysvgnode", "")[
      "replace"
    ]("mysvgbar", "");
    var _0x1778F, _0x15147;
    if (_0x14F5D["indexOf"]("_") > -1) {
      _0x1778F = parseInt(_0x14F5D["split"]("_")[1]);
      _0x15147 = parseInt(_0x14F5D["split"]("_")[0]);
    } else {
      _0x1778F = parseInt(_0x14F5D);
      _0x15147 = -1;
    }
    setStaffName(parseInt(_0x15147) + 1, "\u58f0\u90e8\u540d\u79f0", "\u58f0\u90e8\u526f\u540d\u79f0");
  }
}
function setStaffName(_0x15147, _0x14DD5, _0x14E37) {
  var _0x176CB = new RegExp("V:\\s*" + _0x15147 + ".*");
  var abc_content = $("#source")["val"]();
  var _0x11BAF = _0x176CB["exec"](abc_content);
  console["log"](_0x11BAF);
  if (_0x11BAF != null) {
    var _0x1772D = _0x11BAF[0];
    var _0x174E1 = new RegExp('nm=\\"(.[^"]*)\\"');
    var _0x17607 = new RegExp('snm=\\"(.[^"]*)\\"');
    var _0x1747F = _0x174E1["exec"](_0x1772D);
    if (_0x1747F != null) {
      var _0x17543 = 'nm="' + _0x1747F[1] + '"';
      _0x1772D = _0x1772D["replace"](
        _0x17543,
        'nm="' + _0x14DD5 + '"'
      );
    } else {
      _0x1772D += ' nm="' + _0x14DD5 + '"';
    }
    var _0x175A5 = _0x17607["exec"](_0x1772D);
    if (_0x175A5 != null) {
      var _0x17669 = 'snm="' + _0x175A5[1] + '"';
      _0x1772D = _0x1772D["replace"](
        _0x17669,
        'snm="' + _0x14E37 + '"'
      );
    } else {
      _0x1772D += ' snm="' + _0x14E37 + '"';
    }
    console["log"](_0x1772D);
    abc_content = abc_content["replace"](_0x176CB, _0x1772D);
    $("#source")["val"](abc_content);
    doLog();
    src_change();
  } else {
    var _0x1772D =
      "V:" +
      _0x15147 +
      ' nm="' +
      _0x14DD5 +
      '" snm="' +
      _0x14E37 +
      '"';
    var _0x11A89 = getLinesInfo(abc_content);
    var _0x11C11 = "";
    var _0x12C25 = 0;
    for (var _0x11901 = 0; _0x11901 < _0x11A89["length"]; _0x11901++) {
      var _0x12541 = _0x11A89[_0x11901];
      if (_0x12541["type"] == "note") {
        if (_0x12C25 == 0) {
          _0x11C11 += _0x1772D + "\x0A";
        }
        _0x12C25++;
      }
      _0x11C11 += _0x12541 + "\x0A";
    }
    $("#source")["val"](_0x11C11);
    doLog();
    src_change();
  }
}
function setNoteJpText() {
  var _0x171D1 = $(".selected_text");
  if (_0x171D1["length"] == 0) {
    return;
  }
  var _0x1278D = $("#noteJpText")["val"]();
  if (_0x1278D == "") {
    var _0x12FF9 = $(_0x171D1)["attr"]("istart");
    var _0x13245 = syms[_0x12FF9];
    var _0x1710D = getGch(_0x13245, "jptext:");
    if (_0x1710D != "") {
      var abc_content = $("#source")["val"]();
      abc_content =
        replaceLast(
          abc_content["substring"](0, _0x12FF9),
          '"' + _0x1710D + '"',
          ""
        ) + abc_content["substring"](_0x12FF9);
      $("#source")["val"](abc_content);
      doLog();
      src_change();
      showProperties("staff");
    }
    return;
  }
  var _0x17049 = '"jptext:' + _0x1278D;
  var _0x12FF9 = $(_0x171D1)["attr"]("istart");
  var _0x13245 = syms[_0x12FF9];
  var _0x1710D = getGch(_0x13245, "jptext:");
  if (!_0x1710D) {
    _0x1710D = "";
  }
  var _0x1716F = _0x1710D["replace"]("jptext:", "");
  var _0x170AB = "";
  if (_0x1716F["split"](":")["length"] > 1) {
    _0x170AB = _0x1716F["split"](":")[1];
  }
  if (_0x170AB != "") {
    _0x17049 += ":" + _0x170AB;
  }
  _0x17049 += '"';
  var abc_content = $("#source")["val"]();
  abc_content =
    replaceLast(
      abc_content["substring"](0, _0x12FF9),
      '"' + _0x1710D + '"',
      ""
    ) +
    _0x17049 +
    abc_content["substring"](_0x12FF9);
  $("#source")["val"](abc_content);
  doLog();
  src_change();
  showProperties("staff");
}
function setNoteJpTextMidi() {
  var _0x171D1 = $(".selected_text");
  if (_0x171D1["length"] == 0) {
    return;
  }
  var _0x17295 = $("#noteJpText")["val"]();
  if (_0x17295 == "") {
    alert("\u8bf7\u5148\u8bbe\u7f6e\u6587\u672c");
    return;
  }
  var _0x172F7 = $("#noteJpTextMidi")["val"]();
  if (_0x172F7 == "") {
    var _0x12FF9 = $(_0x171D1)["attr"]("istart");
    var _0x13245 = syms[_0x12FF9];
    var _0x1710D = getGch(_0x13245, "jptext:");
    if (_0x1710D != "") {
      var _0x17359 = _0x1710D["split"](":");
      var _0x17233 =
        '"' + _0x17359[0] + ":" + _0x17359[1] + '"';
      var abc_content = $("#source")["val"]();
      abc_content =
        replaceLast(
          abc_content["substring"](0, _0x12FF9),
          '"' + _0x1710D + '"',
          _0x17233
        ) + abc_content["substring"](_0x12FF9);
      $("#source")["val"](abc_content);
      doLog();
      src_change();
      showProperties("staff");
    }
    return;
  }
  var _0x17233 =
    '"jptext:' + _0x17295 + ":" + _0x172F7 + '"';
  var _0x12FF9 = $(_0x171D1)["attr"]("istart");
  var _0x13245 = syms[_0x12FF9];
  var _0x1710D = getGch(_0x13245, "jptext:");
  var abc_content = $("#source")["val"]();
  abc_content =
    replaceLast(
      abc_content["substring"](0, _0x12FF9),
      '"' + _0x1710D + '"',
      _0x17233
    ) + abc_content["substring"](_0x12FF9);
  $("#source")["val"](abc_content);
  doLog();
  src_change();
  showProperties("staff");
}
function setDacsFontSize() {
  var _0x16903 = $("#dacsFontSize")["val"]();
  var abc_content = $("#source")["val"]();
  if (_0x16903 != "") {
    var _0x16965 = /dacsfontsize.*/;
    var _0x13F49 = abc_content["match"](_0x16965);
    if (_0x13F49 != null) {
      var _0x169C7 = _0x13F49[0];
      abc_content = abc_content["replace"](
        _0x169C7,
        _0x169C7["replace"](/[0-9]\d*/, _0x16903)
      );
    } else {
      abc_content = "%%dacsfontsize " + _0x16903 + "\x0A" + abc_content;
    }
  }
  $("#source")["val"](abc_content);
  src_change();
}
function setBarWidth() {
  var _0x13E85 = $("svg[type='rectnode'],svg[type='rectbar']");
  if (_0x13E85["length"] > 0) {
    var abc_content = $("#source")["val"]();
    var _0x117DB = $(_0x13E85[0])["attr"]("barIndex");
    if (!_0x117DB) {
      _0x117DB = $(_0x13E85[0])["attr"]("barindex");
      if (!_0x117DB) {
        return;
      }
    }
    var _0x1677B = $("#barWidthInput")["val"]();
    if (_0x1677B == "0") {
      _0x1677B = "";
    }
    var _0x167DD = "";
    if (_0x1677B != "") {
      _0x167DD = '"barwidth:' + _0x1677B + '"';
    } else {
      _0x167DD = "";
    }
    var _0x11C11 = "";
    var _0x11A89 = getNodesInfo(abc_content);
    for (
      var _0x11901 = 0, _0x119C5 = _0x11A89["length"];
      _0x11901 < _0x119C5;
      _0x11901++
    ) {
      var _0x11A27 = _0x11A89[_0x11901];
      var _0x11AEB = _0x11A27["lineStr"];
      var _0x11B4D = "";
      if (_0x11A27["type"] == "note") {
        for (
          var _0x11963 = 0;
          _0x11963 < _0x11A27["nodes"]["length"];
          _0x11963++
        ) {
          var _0x11BAF = _0x11A27["nodes"][_0x11963];
          if (_0x11BAF["nodeIndex"] == _0x117DB) {
            var _0x165F3 = _0x11BAF["nodeStr"]["replace"](
              /\"barwidth:.[^\"]*\"/,
              ""
            );
            _0x165F3 =
              replaceLast(_0x165F3, _0x11BAF["barLineStr"], "") +
              _0x167DD +
              _0x11BAF["barLineStr"];
            _0x11B4D += _0x165F3;
          } else {
            _0x11B4D += _0x11BAF["nodeStr"];
          }
          lastNodeEndSeq = _0x11BAF["endSeq"];
        }
        _0x11B4D += abc_content["substring"](
          lastNodeEndSeq,
          _0x11A27["endSeq"]
        );
        _0x11C11 += _0x11B4D + "\x0A";
      } else {
        _0x11C11 += _0x11A27["lineStr"] + "\x0A";
      }
    }
    _0x11C11 = _0x11C11["replace"](/\%\%equalbars.*/, "");
    _0x11C11 = "%%equalbars 1\x0A" + _0x11C11;
    _0x11C11 = replaceBlankLine(_0x11C11);
    $("#source")["val"](_0x11C11);
    doLog();
    src_change(function () {
      var _0x16719 = new Array();
      var _0x15CC3 = new Object();
      _0x15CC3["bar_num"] = _0x117DB;
      _0x15CC3["color"] = "#0E518F";
      _0x15CC3["stroke"] = "#0E518F";
      _0x15CC3["v"] = 0;
      _0x16719["push"](_0x15CC3);
      renderStaffNodeBySt(_0x16719, "node");
    });
    return;
  }
}
function setBarWidth2() {
  var _0x168A1 = $("#barWidthInput2")["val"]();
  var _0x1677B = $("#barWidthInput")["attr"]("oldWidth");
  var _0x1683F = parseInt(parseInt(_0x1677B) * parseFloat(_0x168A1));
  $("#barWidthInput")["val"](_0x1683F);
  setBarWidth();
}
function setBarHeight(_0x16655) {
  var _0x13E85 = $("svg[type='rectnode'],svg[type='rectbar']");
  if (_0x13E85["length"] > 0) {
    var abc_content = $("#source")["val"]();
    var _0x117DB = $(_0x13E85[0])["attr"]("barIndex");
    if (!_0x117DB) {
      _0x117DB = $(_0x13E85[0])["attr"]("barindex");
      if (!_0x117DB) {
        return;
      }
    }
    var _0x1652F = "";
    if (_0x16655 == "top") {
      _0x1652F = $("#barHeightTopInput")["val"]();
    } else {
      if (_0x16655 == "bot") {
        _0x1652F = $("#barHeightBotInput")["val"]();
      }
    }
    if (_0x1652F == "0") {
      _0x1652F = "";
    }
    var _0x16591 = "";
    if (_0x1652F != "") {
      _0x16591 = "[I:vskip " + _0x1652F + "]";
    } else {
      _0x16591 = "";
    }
    var _0x11C11 = "";
    var _0x11A89 = getNodesInfo(abc_content);
    for (
      var _0x11901 = 0, _0x119C5 = _0x11A89["length"];
      _0x11901 < _0x119C5;
      _0x11901++
    ) {
      var _0x11A27 = _0x11A89[_0x11901];
      var _0x11AEB = _0x11A27["lineStr"];
      var _0x11B4D = "";
      if (_0x11A27["type"] == "note") {
        for (
          var _0x11963 = 0;
          _0x11963 < _0x11A27["nodes"]["length"];
          _0x11963++
        ) {
          var _0x11BAF = _0x11A27["nodes"][_0x11963];
          if (_0x11BAF["nodeIndex"] == _0x117DB) {
            var _0x166B7 = _0x11BAF["nodeStr"]["indexOf"]("[I:vskip");
            var _0x165F3 = _0x11BAF["nodeStr"];
            if (_0x16655 == "top") {
              if (_0x166B7 < 2) {
                _0x165F3 = _0x11BAF["nodeStr"]["replace"](
                  /\[I:vskip.[^\[]*\]/,
                  ""
                );
              }
              if (_0x165F3["indexOf"]("$") > -1) {
                var _0x164CD = _0x165F3["indexOf"]("$");
                _0x165F3 =
                  _0x165F3["substring"](0, _0x164CD + 1) +
                  _0x16591 +
                  _0x165F3["substring"](_0x164CD + 1);
              } else {
                _0x165F3 = _0x16591 + _0x165F3;
              }
            } else {
              if (_0x16655 == "bot") {
                _0x165F3 = _0x11BAF["nodeStr"]["replace"](
                  /\[I:vskip.[^\[]*\]\|/,
                  ""
                );
                _0x165F3 =
                  replaceLast(_0x165F3, _0x11BAF["barLineStr"], "") +
                  _0x16591 +
                  _0x11BAF["barLineStr"];
              }
            }
            _0x11B4D += _0x165F3;
          } else {
            _0x11B4D += _0x11BAF["nodeStr"];
          }
          lastNodeEndSeq = _0x11BAF["endSeq"];
        }
        _0x11B4D += abc_content["substring"](
          lastNodeEndSeq,
          _0x11A27["endSeq"]
        );
        _0x11C11 += _0x11B4D + "\x0A";
      } else {
        _0x11C11 += _0x11A27["lineStr"] + "\x0A";
      }
    }
    _0x11C11 = replaceBlankLine(_0x11C11);
    $("#source")["val"](_0x11C11);
    doLog();
    src_change(function () {
      var _0x16719 = new Array();
      var _0x15CC3 = new Object();
      _0x15CC3["bar_num"] = _0x117DB;
      _0x15CC3["color"] = "#0E518F";
      _0x15CC3["stroke"] = "#0E518F";
      _0x15CC3["v"] = 0;
      _0x16719["push"](_0x15CC3);
      renderStaffNodeBySt(_0x16719, "node");
    });
    return;
  }
}
function moveNote(_0x1621F) {
  var _0x163A7 = $(".selected_text,.select_text_g");
  if (_0x163A7["length"] > 0) {
    var abc_content = $("#source")["val"]();
    var _0x12FF9 = parseInt($(".selected_text,.select_text_g")["attr"]("istart"));
    var _0x13245 = syms[_0x12FF9];
    update_note_index = 0;
    update_note_istart = _0x12FF9;
    var _0x16345 = abc_content["substring"](0, _0x13245["istart"]);
    var _0x16409 = abc_content["substring"](_0x13245["istart"]);
    var _0x16281 = 0;
    if (_0x13245 && (_0x13245["xOffset"] || _0x13245["xOffset"] == 0)) {
      _0x16345 = replaceLast(_0x16345, /\!.[^\!]*\!/, "");
      _0x16281 = 4 + (_0x13245["xOffset"] + "")["length"];
    }
    if (!_0x13245["xOffset"]) {
      _0x13245["xOffset"] = 0;
    }
    if ("left" == _0x1621F) {
      _0x13245["xOffset"]--;
    } else {
      if ("right" == _0x1621F) {
        _0x13245["xOffset"]++;
      }
    }
    var _0x162E3 = 4 + (_0x13245["xOffset"] + "")["length"];
    update_note_istart = update_note_istart + (_0x162E3 - _0x16281);
    var new_abc_content =
      _0x16345 +
      "!x:" +
      _0x13245["xOffset"] +
      "!" +
      _0x16409;
    $("#source")["val"](new_abc_content);
    lastFirstNoteSeq = getFirstNoteSeq();
    if (getFirstNoteSeq() == _0x12FF9) {
      lastFirstNoteSeq += _0x162E3 - _0x16281;
    }
    src_change(function () {
      if (_0x13245["type"] == 0) {
        console["log"]("\u5c0f\u8282\u7ebf");
        $("rect[istart='" + (_0x12FF9 + _0x162E3 - _0x16281) + "']")
          ["css"]("fill-opacity", "0.3")
          ["attr"]("selected", "selected");
        $("rect[istart='" + (_0x12FF9 + _0x162E3 - _0x16281) + "']")[
          "addClass"
        ]("selected_text");
      }
    });
    return;
  }
}
function xdtest() {
  var _0x16719 = JSON["parse"]('[{"istart":295,"sdur":192,"pitch":67,"meter":"2/4","scoretype":"all","lyric":["\u6bcd"],"currlyric":"\u6bcd","startTime":5.0,"dur":0.3},{"istart":296,"sdur":192,"pitch":67,"meter":"2/4","scoretype":"all","lyric":["\u9e21"],"currlyric":"\u9e21","startTime":5.296054493683608,"dur":0.3},{"istart":298,"sdur":192,"pitch":67,"meter":"2/4","scoretype":"all","lyric":["\u6bcd"],"currlyric":"\u6bcd","startTime":5.592108987367215,"dur":0.3},{"istart":299,"sdur":192,"pitch":67,"meter":"2/4","scoretype":"all","lyric":["\u9e21"],"currlyric":"\u9e21","startTime":5.888163481050823,"dur":0.3},{"istart":303,"sdur":192,"pitch":67,"meter":"2/4","scoretype":"all","lyric":["\u53eb"],"currlyric":"\u53eb","startTime":6.18421797473443,"dur":0.3},{"istart":304,"sdur":192,"pitch":70,"meter":"2/4","scoretype":"all","lyric":["\u54af"],"currlyric":"\u54af","startTime":6.480272468418038,"dur":0.3},{"istart":306,"sdur":384,"pitch":70,"meter":"2/4","scoretype":"all","lyric":["\u54af"],"currlyric":"\u54af","startTime":6.7763269621016455,"dur":0.6},{"istart":311,"sdur":192,"pitch":65,"meter":"2/4","scoretype":"all","lyric":["\u53eb","\u5ff5\u54af"],"currlyric":"\u53eb","startTime":7.368435949468861,"dur":0.3},{"istart":312,"sdur":192,"pitch":68,"meter":"2/4","scoretype":"all","lyric":["\u54af","\u54af"],"currlyric":"\u54af","startTime":7.664490443152468,"dur":0.3},{"istart":314,"sdur":384,"pitch":68,"meter":"2/4","scoretype":"all","lyric":["\u54af","\u54d2"],"currlyric":"\u54af","startTime":7.960544936836075,"dur":0.6},{"istart":319,"sdur":192,"pitch":67,"meter":"2/4","scoretype":"all","lyric":["\u53eb","\u54af"],"currlyric":"\u53eb","startTime":8.552653924203291,"dur":0.3},{"istart":320,"sdur":192,"pitch":70,"meter":"2/4","scoretype":"all","lyric":["\u54af","\u54af"],"currlyric":"\u54af","startTime":8.848708417886897,"dur":0.3},{"istart":322,"sdur":384,"pitch":70,"meter":"2/4","scoretype":"all","lyric":["\u54af","\u54d2"],"currlyric":"\u54af","startTime":9.144762911570506,"dur":0.6},{"istart":394,"sdur":192,"pitch":67,"meter":"2/4","scoretype":"all","lyric":["\u6bcd"],"currlyric":"\u6bcd","startTime":9.736871898937721,"dur":0.3},{"istart":395,"sdur":192,"pitch":67,"meter":"2/4","scoretype":"all","lyric":["\u9e21"],"currlyric":"\u9e21","startTime":10.032926392621327,"dur":0.3},{"istart":397,"sdur":192,"pitch":67,"meter":"2/4","scoretype":"all","lyric":["\u6bcd"],"currlyric":"\u6bcd","startTime":10.328980886304937,"dur":0.3},{"istart":398,"sdur":192,"pitch":67,"meter":"2/4","scoretype":"all","lyric":["\u9e21"],"currlyric":"\u9e21","startTime":10.625035379988542,"dur":0.3},{"istart":402,"sdur":192,"pitch":67,"meter":"2/4","scoretype":"all","lyric":["\u53eb"],"currlyric":"\u53eb","startTime":10.92108987367215,"dur":0.3},{"istart":403,"sdur":192,"pitch":70,"meter":"2/4","scoretype":"all","lyric":["\u54af"],"currlyric":"\u54af","startTime":11.217144367355758,"dur":0.3},{"istart":405,"sdur":384,"pitch":70,"meter":"2/4","scoretype":"all","lyric":["\u54af"],"currlyric":"\u54af","startTime":11.513198861039365,"dur":0.6},{"istart":410,"sdur":192,"pitch":68,"meter":"2/4","scoretype":"all","lyric":["\u9e21","\u5ff5\u54af"],"currlyric":"\u9e21","startTime":12.10530784840658,"dur":0.3},{"istart":411,"sdur":192,"pitch":68,"meter":"2/4","scoretype":"all","lyric":["\u86cb","\u54af"],"currlyric":"\u86cb","startTime":12.401362342090188,"dur":0.3},{"istart":413,"sdur":192,"pitch":65,"meter":"2/4","scoretype":"all","lyric":["\u5df2","\u54d2"],"currlyric":"\u5df2","startTime":12.697416835773796,"dur":0.3},{"istart":414,"sdur":192,"pitch":65,"meter":"2/4","scoretype":"all","lyric":["\u751f"],"currlyric":"\u751f","startTime":12.993471329457403,"dur":0.3},{"istart":418,"sdur":768,"pitch":63,"meter":"2/4","scoretype":"all","lyric":["\u843d","\u54af\u54af\u54d2"],"currlyric":"\u843d","startTime":13.28952582314101,"dur":1.2},{"istart":489,"sdur":192,"pitch":65,"meter":"2/4","scoretype":"all","lyric":["\u8116"],"currlyric":"\u8116","startTime":14.473743797875441,"dur":0.3},{"istart":490,"sdur":192,"pitch":68,"meter":"2/4","scoretype":"all","lyric":["\u5b50"],"currlyric":"\u5b50","startTime":14.769798291559049,"dur":0.3},{"istart":492,"sdur":192,"pitch":68,"meter":"2/4","scoretype":"all","lyric":["\u4f38"],"currlyric":"\u4f38","startTime":15.065852785242656,"dur":0.3},{"istart":493,"sdur":192,"pitch":68,"meter":"2/4","scoretype":"all","lyric":["\u4f38"],"currlyric":"\u4f38","startTime":15.361907278926264,"dur":0.3},{"istart":497,"sdur":192,"pitch":67,"meter":"2/4","scoretype":"all","lyric":["\u4e24"],"currlyric":"\u4e24","startTime":15.657961772609871,"dur":0.3},{"istart":498,"sdur":192,"pitch":72,"meter":"2/4","scoretype":"all","lyric":["\u7ffc"],"currlyric":"\u7ffc","startTime":15.954016266293479,"dur":0.3},{"istart":500,"sdur":192,"pitch":70,"meter":"2/4","scoretype":"all","lyric":["\u6251"],"currlyric":"\u6251","startTime":16.250070759977085,"dur":0.3},{"istart":501,"sdur":192,"pitch":67,"meter":"2/4","scoretype":"all","lyric":["\u6251"],"currlyric":"\u6251","startTime":16.54612525366069,"dur":0.3},{"istart":505,"sdur":192,"pitch":65,"meter":"2/4","scoretype":"all","lyric":["\u5411"],"currlyric":"\u5411","startTime":16.8421797473443,"dur":0.3},{"istart":506,"sdur":192,"pitch":68,"meter":"2/4","scoretype":"all","lyric":["\u4eba"],"currlyric":"\u4eba","startTime":17.13823424102791,"dur":0.3},{"istart":508,"sdur":192,"pitch":68,"meter":"2/4","scoretype":"all","lyric":["\u62a5"],"currlyric":"\u62a5","startTime":17.434288734711515,"dur":0.3},{"istart":509,"sdur":192,"pitch":68,"meter":"2/4","scoretype":"all","lyric":["\u559c"],"currlyric":"\u559c","startTime":17.73034322839512,"dur":0.3},{"istart":513,"sdur":192,"pitch":67,"meter":"2/4","scoretype":"all","lyric":["\u6dfb"],"currlyric":"\u6dfb","startTime":18.02639772207873,"dur":0.3},{"istart":514,"sdur":192,"pitch":72,"meter":"2/4","scoretype":"all","lyric":["\u5feb"],"currlyric":"\u5feb","startTime":18.32245221576234,"dur":0.3},{"istart":516,"sdur":384,"pitch":70,"meter":"2/4","scoretype":"all","lyric":["\u4e50"],"currlyric":"\u4e50","startTime":18.618506709445946,"dur":0.6},{"istart":558,"sdur":192,"pitch":67,"meter":"2/4","scoretype":"all","lyric":["\u6bcd","\u5ff5\u54af"],"currlyric":"\u6bcd","startTime":19.21061569681316,"dur":0.3},{"istart":559,"sdur":192,"pitch":67,"meter":"2/4","scoretype":"all","lyric":["\u9e21","\u54af"],"currlyric":"\u9e21","startTime":19.50667019049677,"dur":0.3},{"istart":561,"sdur":192,"pitch":67,"meter":"2/4","scoretype":"all","lyric":["\u6bcd","\u54d2"],"currlyric":"\u6bcd","startTime":19.802724684180376,"dur":0.3},{"istart":562,"sdur":192,"pitch":67,"meter":"2/4","scoretype":"all","lyric":["\u9e21"],"currlyric":"\u9e21","startTime":20.09877917786398,"dur":0.3},{"istart":566,"sdur":192,"pitch":67,"meter":"2/4","scoretype":"all","lyric":["\u53eb","\u54af"],"currlyric":"\u53eb","startTime":20.39483367154759,"dur":0.3},{"istart":567,"sdur":192,"pitch":70,"meter":"2/4","scoretype":"all","lyric":["\u54af","\u54af"],"currlyric":"\u54af","startTime":20.6908881652312,"dur":0.3},{"istart":569,"sdur":384,"pitch":70,"meter":"2/4","scoretype":"all","lyric":["\u54af","\u54d2"],"currlyric":"\u54af","startTime":20.986942658914806,"dur":0.6},{"istart":574,"sdur":192,"pitch":68,"meter":"2/4","scoretype":"all","lyric":["\u9e21","\u54af"],"currlyric":"\u9e21","startTime":21.57905164628202,"dur":0.3},{"istart":575,"sdur":192,"pitch":68,"meter":"2/4","scoretype":"all","lyric":["\u86cb","\u54af"],"currlyric":"\u86cb","startTime":21.875106139965627,"dur":0.3},{"istart":577,"sdur":192,"pitch":65,"meter":"2/4","scoretype":"all","lyric":["\u5df2","\u54af"],"currlyric":"\u5df2","startTime":22.171160633649237,"dur":0.3},{"istart":578,"sdur":192,"pitch":65,"meter":"2/4","scoretype":"all","lyric":["\u751f","\u54d2"],"currlyric":"\u751f","startTime":22.467215127332842,"dur":0.3},{"istart":582,"sdur":768,"pitch":63,"meter":"2/4","scoretype":"all","lyric":["\u843d","\u54d2"],"dur":1.2,"currlyric":"\u843d","startTime":22.763269621016452}]');
  var _0x18CFF = new Array();
  var _0x18D61 = 0;
  var _0x18DC3 = 0;
  for (var _0x11901 = 0; _0x11901 < _0x16719["length"]; _0x11901++) {
    console["log"](_0x16719[_0x11901]);
    var _0x11BAF = _0x16719[_0x11901];
    if (_0x18D61 % (192 * 4) == 0) {
      var _0x1272B = new Object();
      _0x1272B["node_index"] = _0x18DC3++;
      _0x1272B["starttime"] = parseFloat(_0x11BAF["startTime"]) - 0.25;
      _0x18CFF["push"](_0x1272B);
    }
    _0x18D61 += _0x11BAF["sdur"];
  }
  return JSON["stringify"](_0x18CFF);
}
function dotClick() {
  console.log('dotClick');
  var sel_note_obj = $(".selected_text");
  if (sel_note_obj.length > 0) {
    var istart = $(sel_note_obj)["attr"]("istart");
    cen = syms[istart];
    var abc_content = $("#source")["val"]();
    var sel_abc_content = abc_content["substring"](cen["istart"], cen["iend"]);
    var note_arr = sel_abc_content.match(/[A-Ga-gz]{1,}/g);
    var note_str = "";
    if (note_arr != null) {
      for (var i = 0; i < note_arr.length; i++) {
        note_str += note_arr[i];
      }
    }
    if (note_str.length == 1) {
    } else {
      if (note_str.length > 1) {
        note_str = "[" + note_str + "]";
      }
    }
    var g_note = genNoteAndDur(note_str, cen, null, null, true);
    console.log(g_note, note_str);
    g_note["note"] = note_str;
    update_note_istart = istart;
    update_note_index = 0;
    replaceNote("source", cen["istart"], cen["iend"], g_note);
  }
}
function switchMicInput() {
  if ($("#micInput")["hasClass"]("menu-pressed")) {
    closeMic();
    $("#source")["val"](staffTypes["treble"]);
    src_change();
    $("#micInput")["removeClass"]("menu-pressed");
    var _0x18183 = "mic_iframe";
    var _0x18121 = $("#" + _0x18183)["prop"]("contentWindow");
    $("#" + _0x18183)["attr"]("src", "about:blank");
    try {
      _0x18121["document"]["write"]("");
      _0x18121["document"]["clear"]();
    } catch (e) {}
  } else {
    $("#source")["val"](
      staffTypes["mic"]["replace"]("M: 4/4\x0A", "")
    );
    src_change();
    if ($("#graphEditorMenuInsert")["hasClass"]("menu-pressed")) {
      $("#graphEditorMenuUpdate")["click"]();
    }
    $("#micInput")["addClass"]("menu-pressed");
    $("#mic_iframe")["attr"]("src", "mic2pitch.html");
  }
}
function getCurrMicPitch() {
  $("#mic_iframe")[0]["contentWindow"]["getCurrPitch"]();
}
function closeMic() {
  $("#mic_iframe")[0]["contentWindow"]["closeMic"]();
}
function setMicAquireNoteTime() {
  if ($("#micInput")["hasClass"]("menu-pressed")) {
    var _0x15331 = getStaffInfo("source");
    if (_0x15331["speed"]) {
      var _0x12DAD =
        _0x15331["speed"]["meter"]["top"] +
        "/" +
        _0x15331["speed"]["meter"]["bot"] +
        "=" +
        _0x15331["speed"]["val"];
      var _0x16F85 = getDurTimeBySpeed(_0x12DAD, durSetting);
      $("#mic_iframe")[0]["contentWindow"]["setAquireNoteTime"](_0x16F85);
    }
  }
}
function mic2Staff(_0x1615B, _0x16097) {
  noteStr = _0x1615B;
  var _0x15331 = getStaffInfo("source");
  var _0x160F9 = "";
  if (_0x15331["speed"]) {
    var _0x12DAD =
      _0x15331["speed"]["meter"]["top"] +
      "/" +
      _0x15331["speed"]["meter"]["bot"] +
      "=" +
      _0x15331["speed"]["val"];
    var _0x161BD = getDurTimeBySpeed(_0x12DAD, durSetting);
    var _0x16035 = _0x16097 / 1000 / _0x161BD;
    if (_0x16035 >= 0 && _0x16035 <= 4) {
      _0x160F9 = _0x16035["toFixed"](0);
    } else {
      _0x160F9 = 4;
    }
    if (_0x160F9 == "1" || _0x160F9 == "0") {
      _0x160F9 = "";
    }
    if (parseInt(_0x160F9) > 2 && parseInt(_0x160F9) <= 3) {
      _0x160F9 = "2";
    } else {
      if (parseInt(_0x160F9) > 3 && parseInt(_0x160F9) <= 4) {
        _0x160F9 = "4";
      }
    }
  }
  setStandDur(_0x160F9);
  console["log"]("noteStr:", noteStr);
  if (noteStr != "") {
    console["log"]("", noteStr);
    console.log('updateNextNote', noteStr, -1);
    updateNextNote(noteStr, -1);
  }
}
function setStandDur(_0x16097) {
  $(".jp_note")["removeClass"]("selected");
  $(".dotstatus")["removeClass"]("selected");
  if (_0x16097 == "" || _0x16097 == 1) {
    $(".jp_note[dur=192]")["addClass"]("selected");
  } else {
    if (_0x16097 == 2) {
      $(".jp_note[dur=384]")["addClass"]("selected");
    } else {
      if (_0x16097 == 3) {
        $(".jp_note[dur=384]")["addClass"]("selected");
        $(".dotstatus")["addClass"]("selected");
      } else {
        if (_0x16097 == 4) {
          $(".jp_note[dur=768]")["addClass"]("selected");
        }
      }
    }
  }
  console["log"](_0x16097);
  if ($(".operator_sc.selected")["length"] > 0) {
    durSetting = $(".operator_sc.selected")["attr"]("dur");
  }
}
function switchStaffType() {
  var _0x181E5 = $("#staffModule")["val"]();
  console["log"](_0x181E5);
  if (_0x181E5 == "") {
    $("#staffType option")["css"]("display", "");
    return;
  }
  $("#staffType option")["each"](function (_0x11901, _0x147B5) {
    if ($(_0x147B5)["attr"]("module") == _0x181E5) {
      $(_0x147B5)["css"]("display", "");
    } else {
      $(_0x147B5)["css"]("display", "none");
    }
  });
}
var sourceFloatMove = false;
var clickX = 0,
  clickY = 0;
function showFloatEditor() {
  if ($("#editor")["hasClass"]("menu-pressed")) {
    $("#editor")["click"]();
  }
  $("#source")
    ["css"]("position", "absolute")
    ["css"]("display", "block")
    ["css"]("left", "0px")
    ["css"]("top", "30px")
    ["height"](300)
    ["css"]("resize", "both")
    ["css"]("z-index", "9");
  $("#source")["each"](function () {
    this["style"]["setProperty"]("width", "750px", "important");
  });
  $("#source_float_div")
    ["css"]("display", "block")
    ["css"]("left", "0px")
    ["css"]("top", "0px")
    ["css"]("height", "30px")
    ["width"]($("#source")["outerWidth"]());
  $("#float_div")["append"]($("#source"));
  var $textareas = jQuery("#source");
  $textareas["data"]("x", $textareas["outerWidth"]());
  $textareas["data"]("y", $textareas["outerHeight"]());
  $textareas["mouseup"](function () {
    var $this = jQuery(this);
    if (
      $this["outerWidth"]() != $this["data"]("x") ||
      $this["outerHeight"]() != $this["data"]("y")
    ) {
      $("#source_float_div")["width"]($this["outerWidth"]());
    }
    $this["data"]("x", $this["outerWidth"]());
    $this["data"]("y", $this["outerHeight"]());
  });
}
function source_float_mousedown(_0x1216D) {
  clickX = _0x1216D["offsetX"];
  clickY = _0x1216D["offsetY"];
  sourceFloatMove = true;
}
function source_float_mouseup() {
  clickX = 0;
  clickY = 0;
  sourceFloatMove = false;
}
function source_float_mousemove(_0x1216D) {
  if (sourceFloatMove) {
    var _0x138C7 = $("#source_float_div")["offset"]()["left"];
    var _0x17C89 = $("#source_float_div")["offset"]()["top"];
    $("#source_float_div")["css"]("left", _0x1216D["x"] - clickX);
    $("#source")["css"]("left", _0x1216D["x"] - clickX);
    $("#source_float_div")["css"]("top", _0x1216D["y"] - clickY);
    $("#source")["css"](
      "top",
      _0x1216D["y"] - clickY + $("#source_float_div")["height"]()
    );
  }
}
function source_float_change() {
  $("#source")["val"]($("#source_float")["val"]());
  abc_change();
}
// 修改小节时值
function changeNodeDur() {
  var old_top = parseInt($("#barTimeTop").attr("oldval"));
  var old_bot = parseInt($("#barTimeBot").attr("oldval"));
  var new_top = parseInt($("#barTimeTop").val());
  $("#barTimeTop").attr("oldval", new_top);
  var new_bot = parseInt($("#barTimeBot").val());
  $("#barTimeBot").attr("oldval", new_bot);
  var d = new_top / new_bot - old_top / old_bot;
  var node_em = $("svg[type=\'rectnode\'],svg[type=\'rectbar\']");
  // console.log('changeNodeDur:', new_top, new_bot, old_top, old_bot, $(node_em[0]));
  if (node_em.length > 0) {
    var abc_content = $("#source").val();
    var barIndex = $(node_em[0]).attr("barIndex");
    if (!barIndex) {
        barIndex = $(node_em[0]).attr("barindex");
        if (!barIndex) {
            return
        }
    }
    var new_abc_content = "";
    var nodes_info = getNodesInfo(abc_content);
    // console.log('nodes_info', nodes_info);
    for (var i = 0; i < nodes_info.length; i++) {
        var node_info = nodes_info[i];
        // var lineStr = node_info["lineStr"];
        var c_abc_content = "";
        if (node_info["type"] == "note") {
            for (var j = 0; j < node_info["nodes"].length; j++) {
                var c_node = node_info["nodes"][j];
                if (c_node["nodeIndex"] == parseInt(barIndex)) {
                  // console.log('c_node:', c_node, d);
                  // var nodeStr = c_node["nodeStr"];
                  if (d > 0) {
                      var dur_str = getDurStrByNoteDur(1536 * (new_top / new_bot - old_top / old_bot), getNodeFirstNote(c_node)["my_ulen"]);
                      c_abc_content += c_node["nodeStr"]["replace"](c_node["barLineStr"], "") + " z," + dur_str + c_node["barLineStr"];
                      // console.log('c_abc_content1:', c_abc_content);
                  } else if (d < 0) {
                      c_abc_content += nodeCut(c_node, d);
                      // console.log('c_abc_content2:', c_abc_content);
                  }
                    
                } else {
                  c_abc_content += c_node["nodeStr"]
                }
                lastNodeEndSeq = c_node["endSeq"]
            }
            c_abc_content += abc_content["substring"](lastNodeEndSeq, node_info["endSeq"]);
            new_abc_content += c_abc_content + "\x0A"
        } else {
            new_abc_content += node_info["lineStr"] + "\x0A"
        }
    }
    new_abc_content = replaceBlankLine(new_abc_content);
    $("#source").val(new_abc_content);
    doLog();
    src_change(function() {
        var c_node_obj_arr = new Array();
        var c_node_obj = new Object();
        c_node_obj["bar_num"] = barIndex;
        c_node_obj["color"] = "red";
        c_node_obj["stroke"] = "red";
        c_node_obj["v"] = 0;
        c_node_obj_arr["push"](c_node_obj);
        renderStaffNodeBySt(c_node_obj_arr, "node")
    });
    return
  }
}

function nodeCut(_0x4D29, _0x56D9) {
  var _0x4BE9 = $("#source")["val"]();
  var _0x5B89 = decimalsToFractional(_0x56D9);
  var _0x6F61 = 1536 * Math["abs"](_0x56D9);
  console["log"]("dis:", _0x5B89);
  var _0x6F89 = "";
  var _0x6F39 = 0;
  if (_0x56D9 > 0) {
      var _0x5701 = getDurStrByNoteDur(1536 * (newTop / newBot - oldTop / oldBot), getNodeFirstNote(_0x4D29)["my_ulen"]);
      _0x6F89 = _0x4D29["nodeStr"]["replace"](_0x4D29["barLineStr"], "") + " z," + _0x5701 + _0x4D29["barLineStr"]
  } else {
      if (_0x56D9 < 0) {
          var _0x6FB1 = _0x4D29["nodeStr"];
          for (var _0x4C11 = _0x4D29["endSeq"] - 1; _0x4C11 >= _0x4D29["startSeq"]; _0x4C11--) {
              var _0x5661 = syms[_0x4C11];
              if (_0x5661) {
                  if (_0x5661["type"] == 8 || _0x5661["type"] == 10) {
                      if (_0x5661["dur"] == _0x6F61) {
                          var _0x5571 = getMinIstart(_0x5661);
                          var _0x5ED1 = _0x4BE9["substring"](_0x5571, _0x5661["iend"]);
                          _0x6F89 = replaceLast(_0x6FB1, _0x5ED1, "");
                          break
                      } else {
                          if (_0x5661["dur"] > _0x6F61) {
                              var _0x5571 = getMinIstart(_0x5661);
                              var _0x5ED1 = _0x4BE9["substring"](_0x5571, _0x5661["iend"]);
                              var _0x5701 = getDurStrByNoteDur(_0x5661["dur"] - _0x6F61, getNodeFirstNote(_0x4D29)["my_ulen"]);
                              _0x6F89 = replaceLast(_0x6FB1, _0x5ED1, "z," + _0x5701);
                              break
                          } else {
                              if (_0x5661["dur"] < _0x6F61) {
                                  _0x6F61 = _0x6F61 - _0x5661["dur"];
                                  var _0x5571 = getMinIstart(_0x5661);
                                  var _0x5ED1 = _0x4BE9["substring"](_0x5571, _0x5661["iend"]);
                                  _0x6FB1 = replaceLast(_0x6FB1, _0x5ED1, "")
                              }
                          }
                      }
                  }
              }
          }
      }
  }
  ;return _0x6F89
}

function getMinIstart(_0x5661) {
  var _0x5571 = _0x5661["istart"];
  if (_0x5661["a_gch"]) {
      for (var _0x4C39 = 0; _0x4C39 < _0x5661["a_gch"]["length"]; _0x4C39++) {
          if (_0x5661["a_gch"][_0x4C39]["istart"] < _0x5571) {
              _0x5571 = _0x5661["a_gch"][_0x4C39]["istart"]
          }
      }
  }
  ;if (_0x5661["a_dd"]) {
      for (var _0x4C39 = 0; _0x4C39 < _0x5661["a_dd"]["length"]; _0x4C39++) {
          if (_0x5661["a_dd"][_0x4C39]["istart"] < _0x5571) {
              _0x5571 = _0x5661["a_dd"][_0x4C39]["istart"]
          }
      }
  }
  ;return _0x5571
}